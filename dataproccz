WITH params AS (
  SELECT DATE '2025-07-31' AS target_eom
)
SELECT
  'V_DPRT_CREDIT_INSTRUMENTS_ME'        AS table_name,
  COUNT(*)                               AS row_count,
  MIN(END_OF_MONTH_DATE)                 AS min_eom,
  MAX(END_OF_MONTH_DATE)                 AS max_eom
FROM V_DPRT_CREDIT_INSTRUMENTS_ME
-- OPTIONAL date filter (keep or remove):
-- WHERE END_OF_MONTH_DATE = (SELECT target_eom FROM params)
;



WITH params AS (
  SELECT DATE '2025-07-31' AS target_eom
),
num_cols AS (
  SELECT
      c.column_name,
      c.data_type,
      c.ordinal_position
  FROM information_schema.columns c
  WHERE c.table_schema = CURRENT_SCHEMA
    AND c.table_name   = 'V_DPRT_CREDIT_INSTRUMENTS_ME'
    AND UPPER(c.data_type) IN (
      'SMALLINT','INTEGER','BIGINT',
      'NUMERIC','DECIMAL','FLOAT','REAL','DOUBLE PRECISION'
    )
  ORDER BY c.ordinal_position
)
SELECT
  LISTAGG(stmt, ' UNION ALL ' ORDER BY ordinal_position) AS numeric_profile_sql
FROM (
  SELECT
    ordinal_position,
    'SELECT ' ||
      quote_literal(column_name) || ' AS column_name, ' ||
      quote_literal(data_type)   || ' AS data_type, '  ||
      'COUNT(1) AS n_rows, ' ||
      'SUM(CASE WHEN ' || column_name || ' IS NOT NULL THEN 1 ELSE 0 END) AS n_non_null, ' ||
      'SUM(CASE WHEN ' || column_name || ' IS NULL THEN 1 ELSE 0 END) AS n_null, ' ||
      'CASE WHEN COUNT(1)=0 THEN 0 ELSE (SUM(CASE WHEN ' || column_name || ' IS NULL THEN 1 ELSE 0 END)::FLOAT/COUNT(1)) END AS pct_null, ' ||
      'COUNT(DISTINCT ' || column_name || ') AS n_distinct, ' ||
      'MIN('  || column_name || ') AS min_val, ' ||
      'MAX('  || column_name || ') AS max_val, ' ||
      'AVG('  || column_name || ') AS avg_val, ' ||
      'STDDEV(' || column_name || ') AS stddev_val ' ||
    'FROM V_DPRT_CREDIT_INSTRUMENTS_ME ' ||
    '-- OPTIONAL date filter:' ||
    ' /* WHERE END_OF_MONTH_DATE = (SELECT target_eom FROM params) */'
    AS stmt
  FROM num_cols
) q
;


WITH params AS (
  SELECT DATE '2025-07-31' AS target_eom
),
cat_cols AS (
  SELECT
      c.column_name,
      c.data_type,
      c.ordinal_position
  FROM information_schema.columns c
  WHERE c.table_schema = CURRENT_SCHEMA
    AND c.table_name   = 'V_DPRT_CREDIT_INSTRUMENTS_ME'
    AND (
         UPPER(c.data_type) LIKE '%CHAR%'
      OR UPPER(c.data_type) IN ('VARCHAR','NVARCHAR','CHAR','NCHAR','BPCHAR','TEXT')
      OR UPPER(c.data_type) IN ('BOOLEAN','DATE','TIMESTAMP','TIMESTAMP WITH TIME ZONE')
    )
  ORDER BY c.ordinal_position
)
SELECT
  LISTAGG(stmt, ' UNION ALL ' ORDER BY ordinal_position) AS cat_profile_sql
FROM (
  SELECT
    ordinal_position,
    'SELECT ' ||
      quote_literal(column_name) || ' AS column_name, ' ||
      quote_literal(data_type)   || ' AS data_type, '  ||
      'COUNT(1) AS n_rows, ' ||
      'SUM(CASE WHEN ' || column_name || ' IS NOT NULL THEN 1 ELSE 0 END) AS n_non_null, ' ||
      'SUM(CASE WHEN ' || column_name || ' IS NULL THEN 1 ELSE 0 END) AS n_null, ' ||
      'CASE WHEN COUNT(1)=0 THEN 0 ELSE (SUM(CASE WHEN ' || column_name || ' IS NULL THEN 1 ELSE 0 END)::FLOAT/COUNT(1)) END AS pct_null, ' ||
      'COUNT(DISTINCT ' || column_name || ') AS n_distinct, ' ||
      'MIN(LENGTH((' || column_name || ')::VARCHAR)) AS min_len, ' ||
      'MAX(LENGTH((' || column_name || ')::VARCHAR)) AS max_len ' ||
    'FROM V_DPRT_CREDIT_INSTRUMENTS_ME ' ||
    '-- OPTIONAL date filter:' ||
    ' /* WHERE END_OF_MONTH_DATE = (SELECT target_eom FROM params) */'
    AS stmt
  FROM cat_cols
) q
;




WITH params AS (
  SELECT DATE '2025-07-31' AS target_eom
),
cat_cols AS (
  SELECT
      c.column_name,
      c.data_type,
      c.ordinal_position
  FROM information_schema.columns c
  WHERE c.table_schema = CURRENT_SCHEMA
    AND c.table_name   = 'V_DPRT_CREDIT_INSTRUMENTS_ME'
    AND (
         UPPER(c.data_type) LIKE '%CHAR%'
      OR UPPER(c.data_type) IN ('VARCHAR','NVARCHAR','CHAR','NCHAR','BPCHAR','TEXT')
      OR UPPER(c.data_type) IN ('BOOLEAN','DATE','TIMESTAMP','TIMESTAMP WITH TIME ZONE')
    )
  ORDER BY c.ordinal_position
)
SELECT
  LISTAGG(stmt, ' UNION ALL ' ORDER BY ordinal_position) AS cat_topk_sql
FROM (
  SELECT
    ordinal_position,
    'SELECT ' ||
      quote_literal(column_name) || ' AS column_name, ' ||
      column_name || '::VARCHAR  AS value_text, ' ||
      'COUNT(*) AS value_count, ' ||
      'COUNT(*)::FLOAT / NULLIF(SUM(CASE WHEN ' || column_name || ' IS NOT NULL THEN 1 ELSE 0 END) OVER (),0) AS pct_of_non_null ' ||
    'FROM V_DPRT_CREDIT_INSTRUMENTS_ME ' ||
    '-- OPTIONAL date filter:' ||
    ' /* WHERE END_OF_MONTH_DATE = (SELECT target_eom FROM params) */ ' ||
    'GROUP BY ' || column_name || ' ' ||
    'ORDER BY value_count DESC ' ||
    'FETCH FIRST 5 ROWS ONLY'
    AS stmt
  FROM cat_cols
) q
;





