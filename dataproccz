-- Basic volume + date span (remove the MIN/MAX lines if you don't have a date column)
SELECT
  'V_DPRT_CREDIT_INSTRUMENTS_ME' AS table_name,
  COUNT(*)                       AS row_count
  -- , MIN(END_OF_MONTH_DATE)     AS min_eom
  -- , MAX(END_OF_MONTH_DATE)     AS max_eom
FROM V_DPRT_CREDIT_INSTRUMENTS_ME
-- OPTIONAL single cut:
-- WHERE END_OF_MONTH_DATE = DATE '2025-07-31'
;




WITH cols AS (
  SELECT
      attname AS column_name,
      atttype AS data_type,
      attnum  AS ordinal_position
  FROM _v_relation_column
  WHERE objname = 'V_DPRT_CREDIT_INSTRUMENTS_ME'
),
num_cols AS (
  SELECT column_name, data_type, ordinal_position
  FROM cols
  WHERE
      UPPER(data_type) LIKE 'SMALLINT%'
   OR UPPER(data_type) LIKE 'INTEGER%'
   OR UPPER(data_type) LIKE 'BIGINT%'
   OR UPPER(data_type) LIKE 'NUMERIC%'
   OR UPPER(data_type) LIKE 'DECIMAL%'
   OR UPPER(data_type) LIKE 'REAL%'
   OR UPPER(data_type) LIKE 'DOUBLE PRECISION%'
   OR UPPER(data_type) LIKE 'FLOAT%'
)
SELECT
  LISTAGG(stmt, ' UNION ALL ') AS numeric_profile_sql
FROM (
  SELECT
    'SELECT ' ||
      '''' || column_name || ''' AS column_name, ' ||
      '''' || data_type   || ''' AS data_type, '  ||
      'COUNT(1) AS n_rows, ' ||
      'SUM(CASE WHEN "' || column_name || '" IS NOT NULL THEN 1 ELSE 0 END) AS n_non_null, ' ||
      'SUM(CASE WHEN "' || column_name || '" IS NULL THEN 1 ELSE 0 END) AS n_null, ' ||
      'CASE WHEN COUNT(1)=0 THEN 0 ' ||
      '     ELSE CAST(SUM(CASE WHEN "' || column_name || '" IS NULL THEN 1 ELSE 0 END) AS DOUBLE PRECISION) / COUNT(1) ' ||
      'END AS pct_null, ' ||
      'COUNT(DISTINCT "' || column_name || '") AS n_distinct, ' ||
      'MIN("'  || column_name || '") AS min_val, ' ||
      'MAX("'  || column_name || '") AS max_val, ' ||
      'AVG("'  || column_name || '") AS avg_val, ' ||
      'STDDEV("'|| column_name || '") AS stddev_val ' ||
    'FROM V_DPRT_CREDIT_INSTRUMENTS_ME ' ||
    '-- OPTIONAL filter: WHERE END_OF_MONTH_DATE = DATE ''2025-07-31''' AS stmt
  FROM num_cols
  ORDER BY ordinal_position
) q;


WITH cols AS (
  SELECT
      attname AS column_name,
      atttype AS data_type,
      attnum  AS ordinal_position
  FROM _v_relation_column
  WHERE objname = 'V_DPRT_CREDIT_INSTRUMENTS_ME'
),
cat_cols AS (
  SELECT column_name, data_type, ordinal_position
  FROM cols
  WHERE
        UPPER(data_type) LIKE 'CHAR%'
     OR UPPER(data_type) LIKE 'VARCHAR%'
     OR UPPER(data_type) LIKE 'NCHAR%'
     OR UPPER(data_type) LIKE 'NVARCHAR%'
     OR UPPER(data_type) LIKE 'BPCHAR%'
     OR UPPER(data_type) LIKE 'TEXT%'
     OR UPPER(data_type) LIKE 'DATE%'
     OR UPPER(data_type) LIKE 'TIMESTAMP%'
     OR UPPER(data_type) LIKE 'BOOLEAN%'
)
SELECT
  LISTAGG(stmt, ' UNION ALL ') AS cat_profile_sql
FROM (
  SELECT
    'SELECT ' ||
      '''' || column_name || ''' AS column_name, ' ||
      '''' || data_type   || ''' AS data_type, '  ||
      'COUNT(1) AS n_rows, ' ||
      'SUM(CASE WHEN "' || column_name || '" IS NOT NULL THEN 1 ELSE 0 END) AS n_non_null, ' ||
      'SUM(CASE WHEN "' || column_name || '" IS NULL THEN 1 ELSE 0 END) AS n_null, ' ||
      'CASE WHEN COUNT(1)=0 THEN 0 ' ||
      '     ELSE CAST(SUM(CASE WHEN "' || column_name || '" IS NULL THEN 1 ELSE 0 END) AS DOUBLE PRECISION) / COUNT(1) ' ||
      'END AS pct_null, ' ||
      'COUNT(DISTINCT "' || column_name || '") AS n_distinct, ' ||
      'MIN(LENGTH(CAST("' || column_name || '" AS VARCHAR(4000)))) AS min_len, ' ||
      'MAX(LENGTH(CAST("' || column_name || '" AS VARCHAR(4000)))) AS max_len ' ||
    'FROM V_DPRT_CREDIT_INSTRUMENTS_ME ' ||
    '-- OPTIONAL filter: WHERE END_OF_MONTH_DATE = DATE ''2025-07-31''' AS stmt
  FROM cat_cols
  ORDER BY ordinal_position
) q;



WITH cols AS (
  SELECT
      attname AS column_name,
      atttype AS data_type,
      attnum  AS ordinal_position
  FROM _v_relation_column
  WHERE objname = 'V_DPRT_CREDIT_INSTRUMENTS_ME'
),
cat_cols AS (
  SELECT column_name, data_type, ordinal_position
  FROM cols
  WHERE
        UPPER(data_type) LIKE 'CHAR%'
     OR UPPER(data_type) LIKE 'VARCHAR%'
     OR UPPER(data_type) LIKE 'NCHAR%'
     OR UPPER(data_type) LIKE 'NVARCHAR%'
     OR UPPER(data_type) LIKE 'BPCHAR%'
     OR UPPER(data_type) LIKE 'TEXT%'
     OR UPPER(data_type) LIKE 'DATE%'
     OR UPPER(data_type) LIKE 'TIMESTAMP%'
     OR UPPER(data_type) LIKE 'BOOLEAN%'
)
SELECT
  LISTAGG(stmt, ' UNION ALL ') AS cat_topk_sql
FROM (
  SELECT
    'SELECT ' ||
      '''' || column_name || ''' AS column_name, ' ||
      'CAST("' || column_name || '" AS VARCHAR(4000)) AS value_text, ' ||
      'COUNT(*) AS value_count, ' ||
      'COUNT(*) * 1.0 / NULLIF(SUM(CASE WHEN "' || column_name || '" IS NOT NULL THEN 1 ELSE 0 END) OVER (), 0) AS pct_of_non_null ' ||
    'FROM V_DPRT_CREDIT_INSTRUMENTS_ME ' ||
    '-- OPTIONAL filter: WHERE END_OF_MONTH_DATE = DATE ''2025-07-31'' ' ||
    'GROUP BY "' || column_name || '" ' ||
    'ORDER BY value_count DESC ' ||
    'LIMIT 5' AS stmt
  FROM cat_cols
  ORDER BY ordinal_position
) q;




