/* ===== Last 12 months MoM by System with $/% changes & ≥5% abs flag ===== */
WITH bounds AS (
    SELECT
        AsOfMonthEnd  = (SELECT MAX(n.LoadDt) FROM crdadmprd.dbo.NAC_Net_Available_Commitments_Monthly_History AS n)
),
win AS (
    SELECT
        AsOfMonthEnd,
        StartMonthEnd = DATEADD(MONTH, -11, AsOfMonthEnd)
    FROM bounds
),
-- Derive System at row level, then aggregate to System x MonthEnd
base AS (
    SELECT
        MonthEnd = CONVERT(date, n.LoadDt),
        System = CASE
                    WHEN EXISTS (
                        SELECT 1
                        FROM crdadmprd.dbo.CDM_Cards_Loan AS cc
                        WHERE cc.Cust_Line_Number = n.CrLineID
                    ) THEN 'Cards'
                    WHEN n.Source = 'CF'                 THEN 'CFD'
                    WHEN n.CrLineID LIKE '%iMX%'         THEN 'iMX'
                    WHEN n.Source = 'LN'                 THEN 'CBS'
                    WHEN n.Source = 'LO'                 THEN 'UBS'
                    WHEN n.Source = 'LJ'                 THEN 'LJ'
                    ELSE ISNULL(NULLIF(n.Source,''), 'Unknown')
                END,
        SecUnfunded = n.SEC_Unfunded,
        NetUtilized = n.NetUtilized
    FROM crdadmprd.dbo.NAC_Net_Available_Commitments_Monthly_History AS n
    CROSS JOIN win w
    WHERE n.LoadDt >= w.StartMonthEnd
      AND n.LoadDt <= w.AsOfMonthEnd
),
sys_month AS (
    SELECT
        b.MonthEnd,
        b.System,
        SecUnfunded = SUM(b.SecUnfunded),
        NetUtilized = SUM(b.NetUtilized),
        Commitment  = SUM(b.NetUtilized + b.SecUnfunded)
    FROM base b
    GROUP BY b.MonthEnd, b.System
),
chg AS (
    SELECT
        MonthEnd,
        System,
        SecUnfunded,
        NetUtilized,
        Commitment,
        Prev_SecUnfunded = LAG(SecUnfunded) OVER (PARTITION BY System ORDER BY MonthEnd),
        Prev_NetUtilized = LAG(NetUtilized) OVER (PARTITION BY System ORDER BY MonthEnd),
        Prev_Commitment  = LAG(Commitment)  OVER (PARTITION BY System ORDER BY MonthEnd)
    FROM sys_month
)
SELECT
    MonthEnd,
    System,
    SecUnfunded,
    NetUtilized,
    Commitment,

    -- MoM $ Changes
    MoM_Change_SecUnfunded = SecUnfunded - Prev_SecUnfunded,
    MoM_Change_NetUtilized = NetUtilized - Prev_NetUtilized,
    MoM_Change_Commitment  = Commitment  - Prev_Commitment,

    -- MoM % Changes (decimal; format as % in Power BI)
    MoM_Pct_SecUnfunded = CASE WHEN Prev_SecUnfunded IS NULL OR Prev_SecUnfunded = 0
                               THEN NULL
                               ELSE (SecUnfunded - Prev_SecUnfunded) / Prev_SecUnfunded
                          END,
    MoM_Pct_NetUtilized = CASE WHEN Prev_NetUtilized IS NULL OR Prev_NetUtilized = 0
                               THEN NULL
                               ELSE (NetUtilized - Prev_NetUtilized) / Prev_NetUtilized
                          END,
    MoM_Pct_Commitment  = CASE WHEN Prev_Commitment IS NULL OR Prev_Commitment = 0
                               THEN NULL
                               ELSE (Commitment - Prev_Commitment) / Prev_Commitment
                          END,

    -- Flag absolute % ≥ 5% on Commitment (use for conditional formatting)
    MoM_Pct_Commitment_Abs_GE_5_Flag =
        CASE
            WHEN Prev_Commitment IS NOT NULL AND Prev_Commitment <> 0
                 AND ABS( (Commitment - Prev_Commitment) / Prev_Commitment ) >= 0.05
            THEN 1 ELSE 0
        END
FROM chg
ORDER BY MonthEnd, System;