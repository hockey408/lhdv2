/* ===== Last 12 months detail with derived System & Commitment ===== */
WITH bounds AS (
    SELECT
        AsOfMonthEnd  = (SELECT MAX(n.LoadDt) FROM crdadmprd.dbo.NAC_Net_Available_Commitments_Monthly_History AS n)
),
win AS (
    SELECT
        AsOfMonthEnd,
        StartMonthEnd = DATEADD(MONTH, -11, AsOfMonthEnd)
    FROM bounds
)
SELECT
    LoadDate         = CONVERT(date, n.LoadDt),              -- month end
    ApplID           = n.ApplID,                             -- remove if not in source
    CreditLineNumber = n.CrLineID,
    SecUnfunded      = n.SEC_Unfunded,
    NetUtilized      = n.NetUtilized,
    Commitment       = n.NetUtilized + n.SEC_Unfunded,
    System = CASE
                WHEN EXISTS (
                    SELECT 1
                    FROM crdadmprd.dbo.CDM_Cards_Loan AS cc
                    WHERE cc.Cust_Line_Number = n.CrLineID
                ) THEN 'Cards'
                WHEN n.Source = 'CF'                 THEN 'CFD'
                WHEN n.CrLineID LIKE '%iMX%'         THEN 'iMX'
                WHEN n.Source = 'LN'                 THEN 'CBS'
                WHEN n.Source = 'LO'                 THEN 'UBS'
                WHEN n.Source = 'LJ'                 THEN 'LJ'
                ELSE ISNULL(NULLIF(n.Source,''), 'Unknown')
            END
FROM crdadmprd.dbo.NAC_Net_Available_Commitments_Monthly_History AS n
CROSS JOIN win w
WHERE n.LoadDt >= w.StartMonthEnd
  AND n.LoadDt <= w.AsOfMonthEnd
ORDER BY n.LoadDt, n.CrLineID;