Portfolio_R2_Latest =
VAR lm       = EOMONTH ( MAX ( T[Month_End] ), 0 )
VAR winStart = EOMONTH ( lm, -11 )
RETURN
AVERAGEX (
    VALUES ( T[RC_CODE] ),
    CALCULATE (
        [R2],                                  -- your existing R2 measure
        FILTER (
            ALL ( T[Month_End] ),              -- remove month filter, then apply window
            T[Month_End] >= winStart
                && T[Month_End] <= lm
        )
    )
)



Portfolio_R2_Latest =
VAR lm       = EOMONTH ( MAX ( T[Month_End] ), 0 )
VAR winStart = EOMONTH ( lm, -11 )
RETURN
AVERAGEX (
    VALUES ( T[RC_CODE] ),
    CALCULATE (
        [R2],
        REMOVEFILTERS ( T[Month_End] ),
        T[Month_End] >= winStart,
        T[Month_End] <= lm
    )
)









=LET(
  /* weights */
  wZ, W_ZResid, wPeer, W_ZPeer, wAbs, W_PctAbs, wMoM, W_ZMoM,
  Wtot, wZ+wPeer+wAbs+wMoM + (wZ+wPeer+wAbs+wMoM=0),

  /* terms */
  zTerm,     wZ   * ABS(IFERROR([@Z_Resid],0)),
  peerTerm,  wPeer* ABS(IFERROR([@Z_Peer],0)),
  absTerm,   wAbs * IFERROR([@PctRank_AbsResid_Month],
                     /* fallback: compute rank within LatestMonth if your column is missing */
                     IFERROR(PERCENTRANK.INC(IF(T[Month_End]=LatestMonth, T[AbsResid]), [@AbsResid]), 0)
           ),
  momTerm,   wMoM * ABS(IFERROR([@Z_MoM_Abs],0)),

  raw, (zTerm + peerTerm + absTerm + momTerm) / Wtot,
  ROUND(100*(1-EXP(-raw)),0)
)


=--([@Severity_Core] >= FlagThreshold)


=LET(
  rc, [@RC_CODE],
  me, [@Month_End],
  look, PersistLookback,                /* named cell, e.g., 3 */
  start, EDATE(me, -(look-1)),
  num, SUMIFS(T[Flag_Anom_Core], T[RC_CODE], rc, T[Month_End], ">="&start, T[Month_End], "<="&me),
  den, COUNTIFS(T[RC_CODE], rc, T[Month_End], ">="&start, T[Month_End], "<="&me),
  IF(den=0, 0, num/den)
)


=LET(
  wZ, W_ZResid, wPeer, W_ZPeer, wAbs, W_PctAbs, wMoM, W_ZMoM, wPers, W_Persist,
  Wtot, wZ+wPeer+wAbs+wMoM+wPers + (wZ+wPeer+wAbs+wMoM+wPers=0),

  raw, (
        wZ   * ABS(IFERROR([@Z_Resid],0)) +
        wPeer* ABS(IFERROR([@Z_Peer],0)) +
        wAbs * IFERROR([@PctRank_AbsResid_Month],
                       IFERROR(PERCENTRANK.INC(IF(T[Month_End]=LatestMonth, T[AbsResid]), [@AbsResid]), 0)) +
        wMoM * ABS(IFERROR([@Z_MoM_Abs],0)) +
        wPers* IFERROR([@Persist_3m],0)
       ) / Wtot,

  ROUND(100*(1-EXP(-raw)),0)
)


=--([@Severity_Final_v5] >= FlagThreshold)









=LET(
  lm, LatestMonth,
  wZ, W_ZResid, wMZ, W_ZMoM, wA, W_Abs, wMA, W_MoMAbs,
  Wtot, wZ+wMZ+wA+wMA + (wZ+wMZ+wA+wMA=0),

  /* latest-month ranks without FILTER (avoids empty spills) */
  vecAbs, IF(T[Month_End]=lm, T[AbsResid]),
  vecMoM, IF(T[Month_End]=lm, T[MoM_Abs]),
  nLM,   SUM(--(T[Month_End]=lm)),
  rAbs,  IF(nLM=0, 0, IFERROR(PERCENTRANK.INC(vecAbs, [@AbsResid]), 0)),
  rMoM,  IF(nLM=0, 0, IFERROR(PERCENTRANK.INC(vecMoM, [@MoM_Abs]), 0)),

  raw, ( wZ*ABS(IFERROR([@Z_Resid],0))
       + wMZ*ABS(IFERROR([@Z_MoM_Abs],0))
       + wA*rAbs
       + wMA*rMoM ) / Wtot,

  ROUND(100*(1-EXP(-raw)),0)
)



=--([@Severity_Core] >= FlagThreshold)


=LET(
  rc, [@RC_CODE],
  me, [@Month_End],
  look, PersistLookback,                 /* e.g., 3; or hardcode 3 */
  start, EDATE(me, -(look-1)),
  num, SUMIFS(T[Flag_Anom_Core], T[RC_CODE], rc, T[Month_End], ">="&start, T[Month_End], "<="&me),
  den, COUNTIFS(T[RC_CODE], rc, T[Month_End], ">="&start, T[Month_End], "<="&me),
  IF(den=0, 0, num/den)
)


=LET(
  boost, PersistBoost,           /* e.g., 15; or hardcode 15 */
  MIN(100, ROUND([@Severity_Core] + boost*[@Persist_3m], 0))
)


=LET(
  mult, 1 + 0.25*[@Persist_3m],         /* up to +25% */
  MIN(100, ROUND([@Severity_Core]*mult, 0))
)


=--([@Severity_Final] >= FlagThreshold)





/* Base helpers */
Total Exposure $ := SUM ( T[Actual] )
Residual := SUMX ( T, T[Actual] - T[Forecast_Selected] )      -- context-aware
Residual^2 := SUMX ( T, (T[Actual]-T[Forecast_Selected])^2 )  -- context-aware

/* Per-context RMSE, MAE, Bias */
RMSE :=
VAR n = COUNTROWS ( T )
RETURN IF ( n = 0, BLANK(), SQRT ( [Residual^2] / n ) )

MAE :=
VAR n = COUNTROWS ( T )
VAR s = SUMX ( T, ABS ( T[Actual]-T[Forecast_Selected] ) )
RETURN DIVIDE ( s, n )

Bias (Mean Residual) :=
VAR n = COUNTROWS ( T )
RETURN DIVIDE ( [Residual], n )

/* Portfolio-style RÂ² in current filter context (RC or portfolio, over selected time window) */
R2 :=
VAR mu  = AVERAGE ( T[Actual] )
VAR SSE = [Residual^2]
VAR SST = SUMX ( T, ( T[Actual] - mu )^2 )
RETURN IF ( SST = 0, BLANK(), 1 - DIVIDE ( SSE, SST ) )

/* MAPE excluding zero Actuals */
MAPE % :=
VAR tbl =
    FILTER ( T, NOT ISBLANK ( T[Actual] ) && T[Actual] <> 0 )
VAR n = COUNTROWS ( tbl )
VAR s = SUMX ( tbl, ABS ( ( T[Actual]-T[Forecast_Selected] ) / T[Actual] ) )
RETURN DIVIDE ( s, n )



/* Average of per-RC RÂ² in the current time window */
Avg R2 by RC :=
AVERAGEX ( VALUES ( T[RC_CODE] ), [R2] )

/* Exposure-weighted RMSE over RCs (optional) */
Weighted RMSE :=
VAR byRC =
    ADDCOLUMNS (
        VALUES ( T[RC_CODE] ),
        "rmse", [RMSE],
        "w", CALCULATE ( [Total Exposure $] )
    )
VAR num = SUMX ( byRC, [rmse] * [w] )
VAR den = SUMX ( byRC, [w] )
RETURN DIVIDE ( num, den )

/* Latest-month exposure for the selected RC (for scatter size or tooltips) */
Latest Month := MAX ( T[Month_End] )

Latest Exposure $ (for RC) :=
VAR lm = [Latest Month]
RETURN CALCULATE ( [Total Exposure $], T[Month_End] = lm )






MoM % :=
VAR curMonth = MAX ( T[Month_End] )
VAR prevVal  =
    CALCULATE (
        [Total Exposure $],
        FILTER ( ALL ( T[Month_End] ), T[Month_End] = EOMONTH ( curMonth, -1 ) )
    )
RETURN
DIVIDE ( [Total Exposure $] - prevVal, prevVal )


Severity Delta :=
VAR curMonth = MAX ( T[Month_End] )
VAR prevSev  =
    CALCULATE (
        [Severity (Avg)],
        FILTER ( ALL ( T[Month_End] ), T[Month_End] = EOMONTH ( curMonth, -1 ) )
    )
RETURN
[Severity (Avg)] - prevSev


Flag Change :=
VAR curMonth = MAX ( T[Month_End] )
VAR curFlag  = [Current Flag]     -- 0 or 1
VAR prevFlag =
    CALCULATE (
        MAX ( T[Flag_Anom] ),
        FILTER ( ALL ( T[Month_End] ), T[Month_End] = EOMONTH ( curMonth, -1 ) )
    )
RETURN
SWITCH (
    TRUE(),
    curFlag = 1 && prevFlag = 0, "ðŸ†• New Flag",
    curFlag = 0 && prevFlag = 1, "âœ… Cleared",
    curFlag = 1 && prevFlag = 1, "â†” Still Flagged",
    "â€”"
)

Indicator Tag (Current) :=
SELECTEDVALUE ( T[Indicator_Tag], "â€”" )

Indicator Tag (Latest) :=
VAR lm =
    CALCULATE ( MAX ( T[Month_End] ), ALLEXCEPT ( T, T[RC_CODE] ) )
RETURN
CALCULATE ( SELECTEDVALUE ( T[Indicator_Tag], "â€”" ), T[Month_End] = lm )










Metrics_Definitions =
DATATABLE (
    "Metric", STRING,
    "Definition", STRING,
    "Calc_Type", STRING,
    "Formula_Text", STRING,
    "Unit", STRING,
{
    { "Actual", "Recorded month-end balance for the RC_Code.", "Column", "T[Actual]", "$" },
    { "Forecast_Selected", "Chosen forecast after model & seasonality selection.", "Column/Calc", "Selected model (REG12/REG36/MA6/MA12) Ã— seasonal lift.", "$" },
    { "Residual", "Difference between Actual and Forecast.", "Row Calc", "Actual âˆ’ Forecast_Selected", "$" },
    { "AbsResid", "Magnitude of the residual.", "Row Calc", "ABS(Residual)", "$" },
    { "MoM_Abs", "Month-over-month absolute change in balance.", "Row Calc", "ABS(Actual âˆ’ Prev_Month_Actual)", "$" },
    { "MoM_Pct_Abs", "Absolute % change vs prior month.", "Row Calc", "ABS((Actual âˆ’ Prev)/Prev)", "%" },
    { "Z_Resid", "Standardized residual vs own history.", "Window Stat", "(AbsResid âˆ’ mean_abs_resid) / sd_abs_resid", "Z" },
    { "Z_MoM_Abs", "Standardized MoM $ change vs own history.", "Window Stat", "(MoM_Abs âˆ’ mean_mom_abs) / sd_mom_abs", "Z" },
    { "Z_MoM_Pct", "Standardized MoM % change vs own history.", "Window Stat", "(MoM_Pct_Abs âˆ’ mean_mom_pct) / sd_mom_pct", "Z" },

    { "Severity_Raw", "Weighted signal combining Z-scores and $ impact.", "Row Calc",
      "0.65*|Z_Resid| + 0.07*|Z_MoM_Abs| + 0.25*RankLM(AbsResid) + 0.03*RankLM(MoM_Abs)", "unitless" },

    { "Severity_0_100_v5", "0â€“100 nonlinear scaling of Severity_Raw.", "Row Calc",
      "ROUND(100*(1 âˆ’ EXP(âˆ’Severity_Raw)),0)", "0â€“100" },

    { "Flag_Anom", "Anomaly flag for latest month (severity above threshold).", "Row Flag",
      "IF(Severity_0_100_v5 â‰¥ Threshold, 1, 0)", "0/1" },

    { "Persist_3m", "Share of last N months flagged (recurrence).", "Cohort Stat",
      "AVG(Flag_Anom over last N months)", "0â€“1" },

    { "Latest_Exposure", "Actual balance for the latest month.", "Agg (Latest)",
      "SUMX( rows where Month_End = MAX(Month_End), Actual )", "$" },

    { "Portfolio RÂ²", "Fit quality: variance explained by forecasts.", "Portfolio Stat",
      "1 âˆ’ SSE/SST; SSE=Î£(Actâˆ’Fcst)Â², SST=Î£(Actâˆ’mean(Act))Â²", "0â€“1" },

    { "RMSE", "Root mean square error (typical $ forecast error).", "Stat",
      "SQRT( AVG( (Actâˆ’Fcst)Â² ) )", "$" },

    { "MAE", "Mean absolute error (typical |$| error).", "Stat",
      "AVG( ABS(Actâˆ’Fcst) )", "$" },

    { "MAPE", "Mean absolute % error (scale-independent).", "Stat",
      "AVG( ABS((Actâˆ’Fcst)/Act) ), ignoring Act=0", "%" },

    { "Bias (Mean Residual)", "Average signed error (over/under-forecast).", "Stat",
      "AVG( Actâˆ’Fcst )", "$" },

    { "Best_Model", "Model picked per RC based on fit rules.", "Label",
      "Argmin(RMSE) with RÂ² guardrails â†’ REG12/REG36/MA6/MA12", "-" },

    { "Seasonal Lift (lift_final)", "Quarterly adjustment damped for spikes.", "Window Calc",
      "Capped & shrunk quarter lift; extra damp if recent spikes.", "multiplier" },

    { "Flagged Exposure %", "Share of exposure in flagged RCs (latest).", "Portfolio KPI",
      "SUM(Actual where Severityâ‰¥Thr) / SUM(Actual)", "%" },

    { "Severity_Category", "Bucketed bands for communication.", "Label",
      "Low<40, Moderate 40â€“69, High 70â€“84, Critical 85+", "-" }
})





Flow_Steps =
DATATABLE (
    "Step_ID", INTEGER,
    "Step_Label", STRING,
    "Step_Description", STRING,
    "Icon", STRING,
    {
        { 1, "Detect Anomalies", "Identify RC_Codes or systems with unusual changes.", "ðŸ”" },
        { 2, "Rank Severity", "Rank anomalies based on severity score (0â€“100).", "âš–ï¸" },
        { 3, "Investigate RC_Code", "Drill into RC_Code details and variance metrics.", "ðŸ§©" },
        { 4, "Drill to Accounts", "Analyze top accounts driving residuals.", "ðŸ“Š" },
        { 5, "Tag Cause", "Assign likely cause (structural change, timing, etc.)", "ðŸ·ï¸" },
        { 6, "Report Summary", "Summarize findings and portfolio impact.", "ðŸ“ˆ" }
    }
)




=AVERAGEIFS(T[AbsResid], T[RC_CODE], [@RC_CODE])

=LET(rc,[@RC_CODE], IFERROR( AVERAGEIFS(T[Resid], T[RC_CODE], rc), 0 ))

=LET(
  rc,[@RC_CODE],
  ybar, SUMIFS(T[Actual],T[RC_CODE],rc) / COUNTIFS(T[RC_CODE],rc),
  sse,  SUMPRODUCT( (T[RC_CODE]=rc) * (T[Actual]-T[Forecast_Selected])^2 ),
  sst,  SUMPRODUCT( (T[RC_CODE]=rc) * (T[Actual]-ybar)^2 ),
  IF(sst=0,0,1 - sse/sst)
)

=LET(
  rc,[@RC_CODE],
  n, COUNTIFS(T[RC_CODE],rc),
  IF(n=0,0, SQRT( SUMPRODUCT((T[RC_CODE]=rc)*(T[Actual]-T[Forecast_Selected])^2) / n ))
)

=LET(rc,[@RC_CODE], IFERROR( AVERAGEIFS(ABS(T[Actual]-T[Forecast_Selected]), T[RC_CODE], rc), 0 ))


=LET(rc,[@RC_CODE], IFERROR( AVERAGEIFS(T[Resid], T[RC_CODE], rc), 0 ))


=LET(rc,[@RC_CODE], STDEV.S( IF(T[RC_CODE]=rc, T[Resid]) ))






=LET(rc,[@RC_CODE],
y,FILTER(T[Actual],T[RC_CODE]=rc),
yhat,FILTER(T[Forecast_Selected],T[RC_CODE]=rc),
ybar,AVERAGE(y),
SSE,SUMPRODUCT((y-yhat)^2),
SST,SUMPRODUCT((y-ybar)^2),
IF(SST=0,0,1-SSE/SST))

=SUMPRODUCT(Summary[R2_per_RC],Summary[Latest_Exposure]) / SUM(Summary[Latest_Exposure])

=COUNTIF(Summary[R2_per_RC],"<0.5")/COUNTA(Summary[R2_per_RC])





=1 - (SUMXMY2(T[Actual],T[Forecast_Selected]) / SUMPRODUCT((T[Actual]-AVERAGE(T[Actual]))^2))

=LET(
lm,$H$2,
Amean,SUMIFS(T[Actual],T[Month_End],lm)/COUNTIFS(T[Month_End],lm),
SSE,SUMPRODUCT((T[Month_End]=lm)*(T[Actual]-T[Forecast_Selected])^2),
SST,SUMPRODUCT((T[Month_End]=lm)*(T[Actual]-Amean)^2),
IF(SST=0,0,1 - SSE/SST)
)

=SQRT( SUMXMY2(T[Actual],T[Forecast_Selected]) / COUNT(T[Actual]) )


=LET(lm,$H$2, SQRT(SUMPRODUCT((T[Month_End]=lm)*(T[Actual]-T[Forecast_Selected])^2) / COUNTIFS(T[Month_End],lm)))

=AVERAGE(ABS(T[Actual]-T[Forecast_Selected]))

=AVERAGEIFS(ABS(T[Actual]-T[Forecast_Selected]), T[Month_End], $H$2)

=AVERAGE(IFERROR(ABS((T[Actual]-T[Forecast_Selected])/T[Actual]),NA()))


=AVERAGE(T[Actual]-T[Forecast_Selected])


=STDEV.S(T[Actual]-T[Forecast_Selected])







=SUMIFS(T[Actual], T[Month_End], $H$2, T[Severity_0_100], ">=70")



=COUNTIFS(T[Month_End],$H$2,T[Severity_0_100],">=70") / COUNTIFS(T[Month_End],$H$2)



=IFERROR(
  SUMIFS(T[Severity_0_100_v5], T[month_end],$H$2, T[Include3_AnyPos],1, T[Severity_0_100_v5],">=",70)
/ COUNTIFS(T[month_end],$H$2, T[Include3_AnyPos],1)
,0)

=SUMIFS(T[Actual], T[month_end],$H$2, T[Include3_AnyPos],1, T[Severity_0_100_v5],">=",70)


=MEDIAN(IF((T[month_end]=$H$2)*(T[Include3_AnyPos]=1), T[AbsResid]))