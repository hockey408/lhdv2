-- Base extract for Python-in-Excel variance analysis
-- One row per (LoadDate, CreditLineNumber)

SET NOCOUNT ON;

DECLARE @LookbackMonths int  = 13;  -- current + 12 back
-- Compute latest month end (works without EOMONTH)
DECLARE @CurrEOM date = DATEADD(DAY, -DAY(CAST(GETDATE() AS date)), CAST(GETDATE() AS date));
DECLARE @StartEOM date = DATEADD(MONTH, -(@LookbackMonths - 1), @CurrEOM);

SELECT
    cu.LoadDate,
    cu.CreditLineNumber,
    CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded,
    cl.CIF,
    cl.ClientName,
    cl.ApplID,
    cl.FormulaLine
FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
       ON cl.LoadDate = cu.LoadDate
      AND cl.CreditLineNumber = cu.CreditLineNumber
WHERE cu.LoadDate >= @StartEOM
  AND cu.LoadDate <= @CurrEOM
-- Optional scope filters:
--   AND cl.ApplID = 'LN'
--   AND cl.FormulaLine = 1
ORDER BY cu.LoadDate, cu.CreditLineNumber;






/*==============================================================
  Base extract for Python-in-Excel variance analysis
  - SQL Server (CRDLMTUFCALC)
  - Pulls current EOM (as of today) + trailing @LookbackMonths-1 EOMs
  - One row per (LoadDate, CreditLineNumber)
==============================================================*/

SET NOCOUNT ON;

DECLARE @CurrEOM         date = EOMONTH(GETDATE(), -1);  -- e.g., today 2025-09-05 -> 2025-08-31
DECLARE @LookbackMonths  int  = 13;  -- current + prior 12 (adjust if you want more history)

;WITH rng AS (
    SELECT
        /* Start at the earliest month we want to include */
        EOMONTH(DATEADD(MONTH, -( @LookbackMonths - 1 ), @CurrEOM)) AS StartEOM,
        @CurrEOM AS EndEOM
),
-- Pull SecUnfunded + join line metadata
raw AS (
    SELECT
        cu.LoadDate,
        cu.CreditLineNumber,
        CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded,
        cl.CIF,
        cl.ClientName,
        cl.ApplID,
        cl.FormulaLine
    FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
    LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
           ON cl.LoadDate = cu.LoadDate
          AND cl.CreditLineNumber = cu.CreditLineNumber
    CROSS JOIN rng
    WHERE cu.LoadDate BETWEEN rng.StartEOM AND rng.EndEOM

    /* Optional: scope filters (uncomment as desired)
       AND cl.ApplID = 'LN'
       AND cl.FormulaLine = 1
       -- AND cl.ClientName IS NOT NULL
       -- AND cu.CreditLineNumber IN ('123456','789012')
    */
),
/* If your source can have duplicates per (LoadDate, CreditLineNumber)
   (e.g., multiple calc runs without RunID scoping), keep a deterministic
   single record. MAX() is a safe choice for balances that should end
   the month at a single figure. Switch to SUM() if your data model
   expects summation across fragments. */
dedup AS (
    SELECT
        LoadDate,
        CreditLineNumber,
        MAX(SecUnfunded) AS SecUnfunded,   -- or SUM(SecUnfunded)
        MAX(CIF)         AS CIF,
        MAX(ClientName)  AS ClientName,
        MAX(ApplID)      AS ApplID,
        MAX(FormulaLine) AS FormulaLine
    FROM raw
    GROUP BY LoadDate, CreditLineNumber
)
SELECT
    LoadDate,
    CreditLineNumber,
    SecUnfunded,      -- numeric, cast already applied
    CIF,
    ClientName,
    ApplID,
    FormulaLine
FROM dedup
ORDER BY LoadDate, CreditLineNumber;








/*=============================================================================
  Portfolio-Wide Review with StDev Floor (Fix A) + SeverityScore/Rank
  - Latest anchor = EOMONTH(GETDATE(), -1)
  - Per credit line: evaluate latest available month on/before anchor
  - Rolling Z vs trailing 12 months (excluding current), with stdev floor
  - Returns union of:
      (a) Top @TopN by |MoM_Diff| and
      (b) All with |Z| >= @ZThreshold (min history)
=============================================================================*/

SET NOCOUNT ON;

DECLARE @CurrEOM          date          = EOMONTH(GETDATE(), -1);
DECLARE @LookbackMonths   int           = 12;
DECLARE @ZThreshold       decimal(10,4) = 2.0000;   -- notable outlier
DECLARE @TopN             int           = 25;       -- top-N abs $ movers
DECLARE @DollarThreshold  decimal(38,2) = NULL;     -- e.g., 250000 to always include big $ moves

-- Severity weights (tune as you like)
DECLARE @wZ   float = 100.0;   -- per 1.0 of |Z|
DECLARE @wAmt float = 10.0;    -- per log10(|$|+1)
DECLARE @wPct float = 1.0;     -- per percentage point (100×|MoM_Pct|)

-- *** Fix A: StDev floor parameters ***
DECLARE @StdFloorAbs         decimal(38,6) = 250.0;   -- absolute $ floor
DECLARE @StdFloorPctOfMean   decimal(9,6)  = 0.005;   -- 0.5% of trailing mean

;WITH rng AS (
    SELECT DATEADD(MONTH, -@LookbackMonths, @CurrEOM) AS StartEOM,
           @CurrEOM                                   AS EndEOM
),
base AS (
    SELECT
        cu.LoadDate,
        cu.CreditLineNumber,
        CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded,
        cl.CIF,
        cl.ClientName,
        cl.ApplID,
        cl.FormulaLine
    FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
    LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
           ON cl.LoadDate = cu.LoadDate
          AND cl.CreditLineNumber = cu.CreditLineNumber
    CROSS JOIN rng
    WHERE cu.LoadDate BETWEEN rng.StartEOM AND rng.EndEOM
),
series AS (
    SELECT
        b.*,
        LAG(b.SecUnfunded, 1) OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate) AS Prev_SecUnfunded,
        AVG(b.SecUnfunded)   OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate
                                   ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS Mean_Prev12,
        STDEV(b.SecUnfunded) OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate
                                   ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS StDev_Prev12,
        COUNT(b.SecUnfunded) OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate
                                   ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS Cnt_Prev12,
        ROW_NUMBER() OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate DESC) AS rn_desc
    FROM base b
),
calc AS (
    SELECT
        s.LoadDate                                AS LoadDate_Curr,
        s.CreditLineNumber,
        s.CIF, s.ClientName, s.ApplID, s.FormulaLine,

        s.SecUnfunded                              AS SecUnfunded_Curr,
        s.Prev_SecUnfunded                         AS SecUnfunded_Prev,

        CAST(s.SecUnfunded - ISNULL(s.Prev_SecUnfunded,0.00) AS decimal(38,2)) AS MoM_Diff,
        CAST(CASE WHEN ISNULL(s.Prev_SecUnfunded,0.00)=0 THEN NULL
                  ELSE (s.SecUnfunded - s.Prev_SecUnfunded) / NULLIF(ABS(s.Prev_SecUnfunded),0.00)
             END AS decimal(38,6)) AS MoM_Pct,

        CAST(s.Mean_Prev12  AS decimal(38,4))  AS Mean_Prev12,
        CAST(s.StDev_Prev12 AS decimal(38,4))  AS StDev_Prev12,
        s.Cnt_Prev12,

        /* -------- Fix A: Z with stdev floor --------
           Effective floor = MAX(@StdFloorAbs, |Mean_Prev12| * @StdFloorPctOfMean)
           If StDev_Prev12 < floor => Z = NULL (unreliable)
        */
        CAST(
          CASE 
            WHEN s.Cnt_Prev12 < 6 THEN NULL  -- require minimum history
            WHEN s.StDev_Prev12 IS NULL THEN NULL
            WHEN s.StDev_Prev12 <
                 CASE 
                   WHEN s.Mean_Prev12 IS NULL THEN @StdFloorAbs
                   ELSE
                     CASE 
                       WHEN @StdFloorAbs > (ABS(s.Mean_Prev12) * @StdFloorPctOfMean)
                            THEN @StdFloorAbs
                            ELSE (ABS(s.Mean_Prev12) * @StdFloorPctOfMean)
                     END
                 END
              THEN NULL
            ELSE (s.SecUnfunded - s.Mean_Prev12) / s.StDev_Prev12
          END AS decimal(38,4)
        ) AS Z_Prev12

    FROM series s
    WHERE s.rn_desc = 1  -- latest available per line
),
ranked_absdiff AS (
    SELECT
        c.*,
        ROW_NUMBER() OVER (ORDER BY ABS(c.MoM_Diff) DESC, c.CreditLineNumber) AS rn_absdiff
    FROM calc c
),
review_set AS (
    SELECT *
    FROM ranked_absdiff r
    WHERE
           (r.Cnt_Prev12 >= 6 AND r.Z_Prev12 IS NOT NULL AND ABS(r.Z_Prev12) >= @ZThreshold)
        OR (r.rn_absdiff <= @TopN)
        OR (@DollarThreshold IS NOT NULL AND ABS(r.MoM_Diff) >= @DollarThreshold)
),
scored AS (
    SELECT
        rs.*,
        ABS(ISNULL(rs.Z_Prev12, 0))             AS AbsZ,
        LOG10(ABS(ISNULL(rs.MoM_Diff,0)) + 1.0) AS LogAmt,
        ABS(ISNULL(rs.MoM_Pct,0)) * 100.0       AS AbsPctPoints,

        (@wZ   * ABS(ISNULL(rs.Z_Prev12, 0))) +
        (@wAmt * LOG10(ABS(ISNULL(rs.MoM_Diff,0)) + 1.0)) +
        (@wPct * (ABS(ISNULL(rs.MoM_Pct,0)) * 100.0)) AS SeverityScore
    FROM review_set rs
)
SELECT
    s.CreditLineNumber,
    s.CIF,
    s.ClientName,
    s.ApplID,
    s.FormulaLine,

    s.LoadDate_Curr,
    s.SecUnfunded_Prev,
    s.SecUnfunded_Curr,

    s.MoM_Diff,
    s.MoM_Pct,

    s.Mean_Prev12,
    s.StDev_Prev12,
    s.Cnt_Prev12,
    s.Z_Prev12,

    s.SeverityScore,

    ROW_NUMBER() OVER (
        ORDER BY
            s.SeverityScore DESC,
            ABS(ISNULL(s.Z_Prev12,0)) DESC,
            ABS(s.MoM_Diff) DESC,
            ABS(ISNULL(s.MoM_Pct,0)) DESC,
            s.CreditLineNumber
    ) AS SeverityRank
FROM scored s
ORDER BY SeverityRank;









DECLARE @StdFloorAbs       decimal(38,6) = 250.0;   -- absolute stdev floor in $
DECLARE @StdFloorPctOfMean decimal(9,6)  = 0.005;   -- 0.5% of trailing mean




-- Effective floor = max(abs floor, % of mean)
CAST(
  CASE
    WHEN s.Cnt_Prev12 < 6 THEN NULL
    ELSE
      CASE 
        WHEN s.StDev_Prev12 IS NULL THEN NULL
        WHEN s.StDev_Prev12 < 
             CASE 
               WHEN s.Mean_Prev12 IS NULL THEN @StdFloorAbs
               ELSE 
                 CASE 
                   WHEN @StdFloorAbs > (ABS(s.Mean_Prev12) * @StdFloorPctOfMean)
                        THEN @StdFloorAbs
                        ELSE (ABS(s.Mean_Prev12) * @StdFloorPctOfMean)
                 END
             END
          THEN NULL
        ELSE (s.SecUnfunded - s.Mean_Prev12) / s.StDev_Prev12
      END
  END AS decimal(38,4)
) AS Z_Prev12







/*=============================================================================
  Portfolio-Wide Review with SeverityScore + SeverityRank
  - Latest anchor = EOMONTH(GETDATE(), -1)
  - Per credit line: evaluate latest available month on/before anchor
  - Compute MoM change + Z vs trailing 12 months (excluding current)
  - Return union of:
      (a) Top @TopN by |MoM_Diff| and
      (b) All with |Z| >= @ZThreshold (min history)
  - Compute SeverityScore and SeverityRank for the final set
=============================================================================*/

SET NOCOUNT ON;

DECLARE @CurrEOM          date          = EOMONTH(GETDATE(), -1);
DECLARE @LookbackMonths   int           = 12;
DECLARE @ZThreshold       decimal(10,4) = 2.0000;  -- notable outlier
DECLARE @TopN             int           = 25;      -- top-N absolute $ movers
DECLARE @DollarThreshold  decimal(38,2) = NULL;    -- e.g., 250000 to always include big $ moves

-- Severity weights (tune these)
DECLARE @wZ   float = 100.0;  -- impact per 1.0 of |Z|
DECLARE @wAmt float = 10.0;   -- impact per log10(|$|+1)
DECLARE @wPct float = 1.0;    -- impact per percentage point of |MoM_Pct| (i.e., 100 * fraction)

;WITH rng AS (
    SELECT DATEADD(MONTH, -@LookbackMonths, @CurrEOM) AS StartEOM,
           @CurrEOM                                   AS EndEOM
),
base AS (
    SELECT
        cu.LoadDate,
        cu.CreditLineNumber,
        CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded,
        cl.CIF,
        cl.ClientName,
        cl.ApplID,
        cl.FormulaLine
    FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
    LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
           ON cl.LoadDate = cu.LoadDate
          AND cl.CreditLineNumber = cu.CreditLineNumber
    CROSS JOIN rng
    WHERE cu.LoadDate BETWEEN rng.StartEOM AND rng.EndEOM
),
series AS (
    SELECT
        b.*,
        LAG(b.SecUnfunded, 1) OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate) AS Prev_SecUnfunded,
        AVG(b.SecUnfunded)   OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate
                                   ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS Mean_Prev12,
        STDEV(b.SecUnfunded) OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate
                                   ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS StDev_Prev12,
        COUNT(b.SecUnfunded) OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate
                                   ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS Cnt_Prev12,
        ROW_NUMBER() OVER (PARTITION BY b.CreditLineNumber ORDER BY b.LoadDate DESC) AS rn_desc
    FROM base b
),
calc AS (
    SELECT
        s.LoadDate                                AS LoadDate_Curr,
        s.CreditLineNumber,
        s.CIF, s.ClientName, s.ApplID, s.FormulaLine,

        s.SecUnfunded                              AS SecUnfunded_Curr,
        s.Prev_SecUnfunded                         AS SecUnfunded_Prev,

        CAST(s.SecUnfunded - ISNULL(s.Prev_SecUnfunded,0.00) AS decimal(38,2)) AS MoM_Diff,
        CAST(CASE WHEN ISNULL(s.Prev_SecUnfunded,0.00)=0 THEN NULL
                  ELSE (s.SecUnfunded - s.Prev_SecUnfunded) / NULLIF(ABS(s.Prev_SecUnfunded),0.00)
             END AS decimal(38,6)) AS MoM_Pct,

        CAST(s.Mean_Prev12  AS decimal(38,4))  AS Mean_Prev12,
        CAST(s.StDev_Prev12 AS decimal(38,4))  AS StDev_Prev12,
        s.Cnt_Prev12,

        CAST(CASE WHEN s.StDev_Prev12 IS NULL OR s.StDev_Prev12=0 THEN NULL
                  ELSE (s.SecUnfunded - s.Mean_Prev12) / s.StDev_Prev12
             END AS decimal(38,4)) AS Z_Prev12,

        CASE WHEN ISNULL(s.Prev_SecUnfunded,0)=0 AND ISNULL(s.SecUnfunded,0)<>0 THEN 1 ELSE 0 END AS Flag_ZeroToNonZero,
        CASE WHEN ISNULL(s.Prev_SecUnfunded,0)<>0 AND ISNULL(s.SecUnfunded,0)=0 THEN 1 ELSE 0 END AS Flag_NonZeroToZero
    FROM series s
    WHERE s.rn_desc = 1  -- latest available per line
),
ranked_absdiff AS (
    SELECT
        c.*,
        ROW_NUMBER() OVER (ORDER BY ABS(c.MoM_Diff) DESC, c.CreditLineNumber) AS rn_absdiff
    FROM calc c
),
review_set AS (
    SELECT *
    FROM ranked_absdiff r
    WHERE
           (r.Cnt_Prev12 >= 6 AND r.Z_Prev12 IS NOT NULL AND ABS(r.Z_Prev12) >= @ZThreshold)
        OR (r.rn_absdiff <= @TopN)
        OR (@DollarThreshold IS NOT NULL AND ABS(r.MoM_Diff) >= @DollarThreshold)
),
scored AS (
    SELECT
        rs.*,
        -- Components for scoring
        ABS(ISNULL(rs.Z_Prev12, 0))                    AS AbsZ,
        LOG10(ABS(ISNULL(rs.MoM_Diff,0)) + 1.0)        AS LogAmt,               -- stable scale for $ moves
        ABS(ISNULL(rs.MoM_Pct,0)) * 100.0              AS AbsPctPoints,         -- convert fraction to pct points

        -- Final SeverityScore (tunable weights)
        (@wZ   * ABS(ISNULL(rs.Z_Prev12, 0))) +
        (@wAmt * LOG10(ABS(ISNULL(rs.MoM_Diff,0)) + 1.0)) +
        (@wPct * (ABS(ISNULL(rs.MoM_Pct,0)) * 100.0))  AS SeverityScore
    FROM review_set rs
)
SELECT
    s.CreditLineNumber,
    s.CIF,
    s.ClientName,
    s.ApplID,
    s.FormulaLine,

    s.LoadDate_Curr,
    s.SecUnfunded_Prev,
    s.SecUnfunded_Curr,

    s.MoM_Diff,
    s.MoM_Pct,

    s.Mean_Prev12,
    s.StDev_Prev12,
    s.Cnt_Prev12,
    s.Z_Prev12,

    s.Flag_ZeroToNonZero,
    s.Flag_NonZeroToZero,

    s.SeverityScore,

    ROW_NUMBER() OVER (
        ORDER BY
            s.SeverityScore DESC,
            ABS(ISNULL(s.Z_Prev12,0)) DESC,
            ABS(s.MoM_Diff) DESC,
            ABS(ISNULL(s.MoM_Pct,0)) DESC,
            s.CreditLineNumber
    ) AS SeverityRank
FROM scored s
ORDER BY SeverityRank;







/*==========================================================
  Single-CreditLine Variance Analysis (12M history + Z-score)
  - Anchors current EOM to latest month-end relative to today
    (e.g., if today is 2025-09-04 -> current EOM = 2025-08-31)
  - Pulls up to 12 prior EOMs (plus current), handles gaps
  - Computes MoM diffs, trailing-12 mean/stdev (prev-12 only),
    and Z-score vs trailing 12 (statistically sound)
==========================================================*/

SET NOCOUNT ON;

DECLARE @CreditLineNumber  varchar(64) = '1234567890';  -- << plug your line
DECLARE @LookbackMonths    int        = 12;
DECLARE @NaturalCurrEOM    date       = EOMONTH(GETDATE(), -1);

/* Latest available EOM for this line on/before @NaturalCurrEOM */
DECLARE @Anchor date =
(
  SELECT MAX(cu.LoadDate)
  FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
  WHERE cu.CreditLineNumber = @CreditLineNumber
    AND cu.LoadDate <= @NaturalCurrEOM
);

IF @Anchor IS NULL
BEGIN
    DECLARE @msg nvarchar(200) =
        CONCAT('No data found on or before ',
               CONVERT(varchar(10), @NaturalCurrEOM, 120),
               ' for CreditLine ', @CreditLineNumber, '.');
    RAISERROR(@msg, 16, 1);
    RETURN;
END;

/* =========================
   A) Full 13-row Panel
   ========================= */
;WITH spine AS (
    -- generate current anchor + 12 prior EOMs
    SELECT 0 AS n, @Anchor AS LoadDate
    UNION ALL
    SELECT n+1,
           EOMONTH(DATEADD(MONTH, -(n+1), @Anchor))
    FROM spine
    WHERE n < @LookbackMonths
),
hist AS (
    SELECT
        s.LoadDate,
        cu.CreditLineNumber,
        CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded
    FROM spine s
    LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
      ON cu.LoadDate = s.LoadDate
     AND cu.CreditLineNumber = @CreditLineNumber
),
histmeta AS (
    SELECT
        h.LoadDate,
        COALESCE(h.CreditLineNumber, @CreditLineNumber) AS CreditLineNumber,
        h.SecUnfunded,
        cl.CIF,
        cl.ClientName,
        cl.ApplID,
        cl.FormulaLine,
        cl.BankCode
    FROM hist h
    LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
      ON cl.LoadDate = h.LoadDate
     AND cl.CreditLineNumber = @CreditLineNumber
),
base AS (
    SELECT
        LoadDate,
        CreditLineNumber,
        SecUnfunded,
        CIF, ClientName, ApplID, FormulaLine, BankCode,

        LAG(SecUnfunded, 1) OVER (ORDER BY LoadDate) AS Prev_SecUnfunded,

        -- trailing statistics over the *previous* 12 months (excludes current)
        AVG(SecUnfunded)   OVER (ORDER BY LoadDate ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS Mean_Prev12,
        STDEV(SecUnfunded) OVER (ORDER BY LoadDate ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS StDev_Prev12
    FROM histmeta
)
SELECT
    b.LoadDate,
    b.CreditLineNumber,
    b.CIF, b.ClientName, b.ApplID, b.FormulaLine, b.BankCode,

    b.SecUnfunded,
    b.Prev_SecUnfunded,

    CAST(b.SecUnfunded - ISNULL(b.Prev_SecUnfunded,0.00) AS decimal(38,2)) AS MoM_Diff,
    CAST(CASE WHEN ISNULL(b.Prev_SecUnfunded,0.00)=0 THEN NULL
              ELSE (b.SecUnfunded - b.Prev_SecUnfunded) / NULLIF(ABS(b.Prev_SecUnfunded),0.00)
         END AS decimal(38,6)) AS MoM_Pct,

    CAST(b.Mean_Prev12 AS decimal(38,4))  AS Mean_Prev12,
    CAST(b.StDev_Prev12 AS decimal(38,4)) AS StDev_Prev12,

    CAST(CASE WHEN b.StDev_Prev12 IS NULL OR b.StDev_Prev12=0 THEN NULL
              ELSE (b.SecUnfunded - b.Mean_Prev12) / b.StDev_Prev12
         END AS decimal(38,4)) AS Z_Prev12,

    CASE WHEN ISNULL(b.Prev_SecUnfunded,0)=0 AND ISNULL(b.SecUnfunded,0)<>0 THEN 1 ELSE 0 END AS Flag_ZeroToNonZero,
    CASE WHEN ISNULL(b.Prev_SecUnfunded,0)<>0 AND ISNULL(b.SecUnfunded,0)=0 THEN 1 ELSE 0 END AS Flag_NonZeroToZero,
    CASE WHEN ABS(
             CASE WHEN b.StDev_Prev12 IS NULL OR b.StDev_Prev12=0 THEN 0
                  ELSE (b.SecUnfunded - b.Mean_Prev12) / b.StDev_Prev12
             END) >= 2 THEN 1 ELSE 0 END AS Flag_Z_2plus,
    CASE WHEN ABS(
             CASE WHEN b.StDev_Prev12 IS NULL OR b.StDev_Prev12=0 THEN 0
                  ELSE (b.SecUnfunded - b.Mean_Prev12) / b.StDev_Prev12
             END) >= 3 THEN 1 ELSE 0 END AS Flag_Z_3plus
FROM base b
ORDER BY b.LoadDate
OPTION (MAXRECURSION 200);

/* =========================
   B) Latest-month Spotlight
   ========================= */
;WITH spine AS (
    SELECT 0 AS n, @Anchor AS LoadDate
    UNION ALL
    SELECT n+1, EOMONTH(DATEADD(MONTH, -(n+1), @Anchor))
    FROM spine
    WHERE n < @LookbackMonths
),
hist AS (
    SELECT s.LoadDate, cu.CreditLineNumber, CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded
    FROM spine s
    LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
      ON cu.LoadDate = s.LoadDate
     AND cu.CreditLineNumber = @CreditLineNumber
),
histmeta AS (
    SELECT h.LoadDate, COALESCE(h.CreditLineNumber, @CreditLineNumber) AS CreditLineNumber,
           h.SecUnfunded, cl.CIF, cl.ClientName, cl.ApplID, cl.FormulaLine, cl.BankCode
    FROM hist h
    LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
      ON cl.LoadDate = h.LoadDate
     AND cl.CreditLineNumber = @CreditLineNumber
),
base AS (
    SELECT LoadDate, CreditLineNumber, SecUnfunded,
           CIF, ClientName, ApplID, FormulaLine, BankCode,
           LAG(SecUnfunded, 1) OVER (ORDER BY LoadDate) AS Prev_SecUnfunded,
           AVG(SecUnfunded)   OVER (ORDER BY LoadDate ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS Mean_Prev12,
           STDEV(SecUnfunded) OVER (ORDER BY LoadDate ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS StDev_Prev12
    FROM histmeta
)
SELECT TOP (1)
    LoadDate, CreditLineNumber, CIF, ClientName, ApplID, FormulaLine, BankCode,
    SecUnfunded, Prev_SecUnfunded,
    CAST(SecUnfunded - ISNULL(Prev_SecUnfunded,0.00) AS decimal(38,2)) AS MoM_Diff,
    CAST(CASE WHEN ISNULL(Prev_SecUnfunded,0.00)=0 THEN NULL
              ELSE (SecUnfunded - Prev_SecUnfunded) / NULLIF(ABS(Prev_SecUnfunded),0.00)
         END AS decimal(38,6)) AS MoM_Pct,
    CAST(Mean_Prev12 AS decimal(38,4))  AS Mean_Prev12,
    CAST(StDev_Prev12 AS decimal(38,4)) AS StDev_Prev12,
    CAST(CASE WHEN StDev_Prev12 IS NULL OR StDev_Prev12=0 THEN NULL
              ELSE (SecUnfunded - Mean_Prev12) / StDev_Prev12
         END AS decimal(38,4)) AS Z_Prev12,
    CASE WHEN ISNULL(Prev_SecUnfunded,0)=0 AND ISNULL(SecUnfunded,0)<>0 THEN 1 ELSE 0 END AS Flag_ZeroToNonZero,
    CASE WHEN ISNULL(Prev_SecUnfunded,0)<>0 AND ISNULL(SecUnfunded,0)=0 THEN 1 ELSE 0 END AS Flag_NonZeroToZero,
    CASE WHEN ABS(CASE WHEN StDev_Prev12 IS NULL OR StDev_Prev12=0 THEN 0 ELSE (SecUnfunded - Mean_Prev12)/StDev_Prev12 END) >= 2 THEN 1 ELSE 0 END AS Flag_Z_2plus,
    CASE WHEN ABS(CASE WHEN StDev_Prev12 IS NULL OR StDev_Prev12=0 THEN 0 ELSE (SecUnfunded - Mean_Prev12)/StDev_Prev12 END) >= 3 THEN 1 ELSE 0 END AS Flag_Z_3plus
FROM base
ORDER BY LoadDate DESC
OPTION (MAXRECURSION 200);

/* =========================
   C) Quick Summary (Panel)
   ========================= */
;WITH spine AS (
    SELECT 0 AS n, @Anchor AS LoadDate
    UNION ALL
    SELECT n+1, EOMONTH(DATEADD(MONTH, -(n+1), @Anchor))
    FROM spine
    WHERE n < @LookbackMonths
),
hist AS (
    SELECT s.LoadDate, cu.CreditLineNumber, CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded
    FROM spine s
    LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
      ON cu.LoadDate = s.LoadDate
     AND cu.CreditLineNumber = @CreditLineNumber
),
histmeta AS (
    SELECT h.LoadDate, COALESCE(h.CreditLineNumber, @CreditLineNumber) AS CreditLineNumber,
           h.SecUnfunded, cl.CIF, cl.ClientName, cl.ApplID, cl.FormulaLine, cl.BankCode
    FROM hist h
    LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
      ON cl.LoadDate = h.LoadDate
     AND cl.CreditLineNumber = @CreditLineNumber
),
base AS (
    SELECT LoadDate, CreditLineNumber, SecUnfunded,
           LAG(SecUnfunded, 1) OVER (ORDER BY LoadDate) AS Prev_SecUnfunded,
           AVG(SecUnfunded)   OVER (ORDER BY LoadDate ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS Mean_Prev12,
           STDEV(SecUnfunded) OVER (ORDER BY LoadDate ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS StDev_Prev12
    FROM histmeta
)
SELECT
    COUNT(*)                                                       AS Rows_In_Panel,
    SUM(CASE WHEN Prev_SecUnfunded IS NULL THEN 0 ELSE 1 END)      AS Rows_With_Prior,
    SUM(CASE WHEN ISNULL(Prev_SecUnfunded,0)=0 AND ISNULL(SecUnfunded,0)<>0 THEN 1 ELSE 0 END) AS Cnt_ZeroToNonZero,
    SUM(CASE WHEN ISNULL(Prev_SecUnfunded,0)<>0 AND ISNULL(SecUnfunded,0)=0 THEN 1 ELSE 0 END) AS Cnt_NonZeroToZero,
    SUM(CASE WHEN ABS(CASE WHEN StDev_Prev12 IS NULL OR StDev_Prev12=0 THEN 0 ELSE (SecUnfunded - Mean_Prev12)/StDev_Prev12 END) >= 2 THEN 1 ELSE 0 END) AS Cnt_Z_Abs_2plus,
    SUM(CASE WHEN ABS(CASE WHEN StDev_Prev12 IS NULL OR StDev_Prev12=0 THEN 0 ELSE (SecUnfunded - Mean_Prev12)/StDev_Prev12 END) >= 3 THEN 1 ELSE 0 END) AS Cnt_Z_Abs_3plus
FROM base
OPTION (MAXRECURSION 200);



/* ==========================================================
   Drill-Down Variance Analysis for ONE CreditLine
   - Pulls last 12 EOM snapshots (plus one extra to get MoM)
   - Computes MoM_Diff / MoM_Pct
   - Rolling (prev-12) mean & stdev
   - Z-score per month vs trailing 12 (excludes the month itself)
   - Flags: |Z|≥2 (moderate), |Z|≥3 (severe), zero↔nonzero switches

   Assumed tables (SQL Server):
     CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED   (LoadDate, CreditLineNumber, SecUnfunded)
     CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY   (LoadDate, CreditLineNumber, CIF, ClientName, ApplID, FormulaLine, BankCode)

   >>> Set @CreditLineNumber below
========================================================== */

SET NOCOUNT ON;

DECLARE @CreditLineNumber  varchar(64) = '1234567890';  -- << plug your line here
DECLARE @CurrEOM          date        = EOMONTH(GETDATE(), -1);  -- latest month-end as of "today"
DECLARE @LookbackMonths    int        = 12;             -- trailing window

/* 0) Resolve current/prior month-ends that actually exist for this line */
IF OBJECT_ID('tempdb..#LineEOM') IS NOT NULL DROP TABLE #LineEOM;

;WITH d AS (
    SELECT DISTINCT LoadDate
    FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED
    WHERE CreditLineNumber = @CreditLineNumber
      AND LoadDate <= @CurrEOM
),
ranked AS (
    SELECT LoadDate,
           ROW_NUMBER() OVER (ORDER BY LoadDate DESC) AS rn
    FROM d
)
SELECT
    MAX(CASE WHEN rn = 1 THEN LoadDate END) AS CurrEOM_Available,
    MAX(CASE WHEN rn = @LookbackMonths + 1 THEN LoadDate END) AS OldestNeededEOM
INTO #LineEOM
FROM ranked;

/* 1) Build a month-end spine (dates) for the last @LookbackMonths + 1 months up to the available current EOM */
IF OBJECT_ID('tempdb..#Spine') IS NOT NULL DROP TABLE #Spine;

DECLARE @Anchor date = (SELECT CurrEOM_Available FROM #LineEOM);
IF @Anchor IS NULL
BEGIN
    RAISERROR('No data found on or before %s for CreditLine %s.', 16, 1, CONVERT(varchar(10), @CurrEOM, 120), @CreditLineNumber);
    RETURN;
END

;WITH spine AS (
    SELECT @Anchor AS LoadDate, 0 AS step
    UNION ALL
    SELECT EOMONTH(DATEADD(MONTH, -1, LoadDate)), step + 1
    FROM spine
    WHERE step < @LookbackMonths
)
SELECT LoadDate
INTO #Spine
FROM spine
OPTION (MAXRECURSION 200);

/* 2) Pull SecUnfunded history for that line, aligned to the spine (left join → preserves missing months) */
IF OBJECT_ID('tempdb..#Hist') IS NOT NULL DROP TABLE #Hist;

SELECT
    s.LoadDate,
    cu.CreditLineNumber,
    CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded
INTO #Hist
FROM #Spine s
LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
    ON cu.LoadDate = s.LoadDate
   AND cu.CreditLineNumber = @CreditLineNumber;

/* 3) Attach some metadata (from CREDIT_LINE_MONTHLY at the same LoadDate, if available) */
IF OBJECT_ID('tempdb..#HistMeta') IS NOT NULL DROP TABLE #HistMeta;

SELECT
    h.LoadDate,
    COALESCE(h.CreditLineNumber, @CreditLineNumber) AS CreditLineNumber,
    h.SecUnfunded,
    cl.CIF,
    cl.ClientName,
    cl.ApplID,
    cl.FormulaLine,
    cl.BankCode
INTO #HistMeta
FROM #Hist h
LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
  ON cl.LoadDate = h.LoadDate
 AND cl.CreditLineNumber = @CreditLineNumber;

/* 4) Compute MoM diffs and rolling stats; Z-score vs trailing 12 (excluding current) */
IF OBJECT_ID('tempdb..#Stats') IS NOT NULL DROP TABLE #Stats;

;WITH base AS (
    SELECT
        LoadDate,
        CreditLineNumber,
        SecUnfunded,
        CIF, ClientName, ApplID, FormulaLine, BankCode,
        LAG(SecUnfunded, 1) OVER (ORDER BY LoadDate) AS Prev_SecUnfunded,

        -- Rolling (prev-12) mean & stdev; excludes the current month by framing to 1 PRECEDING
        AVG(SecUnfunded)  OVER (ORDER BY LoadDate ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS Mean_Prev12,
        STDEV(SecUnfunded)OVER (ORDER BY LoadDate ROWS BETWEEN 12 PRECEDING AND 1 PRECEDING) AS StDev_Prev12
    FROM #HistMeta
)
SELECT
    b.LoadDate,
    b.CreditLineNumber,
    b.CIF, b.ClientName, b.ApplID, b.FormulaLine, b.BankCode,

    b.SecUnfunded,
    b.Prev_SecUnfunded,

    CAST(b.SecUnfunded - ISNULL(b.Prev_SecUnfunded, 0.00) AS decimal(38,2)) AS MoM_Diff,
    CAST(
        CASE WHEN ISNULL(b.Prev_SecUnfunded, 0.00) = 0 THEN NULL
             ELSE (b.SecUnfunded - b.Prev_SecUnfunded) / NULLIF(ABS(b.Prev_SecUnfunded), 0.00)
        END AS decimal(38,6)
    ) AS MoM_Pct,

    CAST(b.Mean_Prev12 AS decimal(38,4))  AS Mean_Prev12,
    CAST(b.StDev_Prev12 AS decimal(38,4)) AS StDev_Prev12,

    CAST(
        CASE WHEN b.StDev_Prev12 IS NULL OR b.StDev_Prev12 = 0 THEN NULL
             ELSE (b.SecUnfunded - b.Mean_Prev12) / b.StDev_Prev12
        END AS decimal(38,4)
    ) AS Z_Prev12,

    CASE WHEN ISNULL(b.Prev_SecUnfunded,0)=0 AND ISNULL(b.SecUnfunded,0)<>0 THEN 1 ELSE 0 END AS Flag_ZeroToNonZero,
    CASE WHEN ISNULL(b.Prev_SecUnfunded,0)<>0 AND ISNULL(b.SecUnfunded,0)=0 THEN 1 ELSE 0 END AS Flag_NonZeroToZero,

    CASE WHEN ABS(
            CASE WHEN b.StDev_Prev12 IS NULL OR b.StDev_Prev12 = 0 THEN 0
                 ELSE (b.SecUnfunded - b.Mean_Prev12) / b.StDev_Prev12 END
        ) >= 2 THEN 1 ELSE 0 END AS Flag_Z_2plus,

    CASE WHEN ABS(
            CASE WHEN b.StDev_Prev12 IS NULL OR b.StDev_Prev12 = 0 THEN 0
                 ELSE (b.SecUnfunded - b.Mean_Prev12) / b.StDev_Prev12 END
        ) >= 3 THEN 1 ELSE 0 END AS Flag_Z_3plus
INTO #Stats
FROM base b;

/* 5) Final outputs
      A) Full 13-row panel (oldest … latest)
      B) Latest-month spotlight (most recent EOM available)
      C) Quick anomaly summary counts across the panel
*/
-- A) Panel
SELECT *
FROM #Stats
ORDER BY LoadDate;

-- B) Latest-month spotlight
SELECT TOP (1) *
FROM #Stats
ORDER BY LoadDate DESC;

-- C) Summary (counts across panel)
SELECT
    COUNT(*)                                           AS Rows_In_Panel,
    SUM(CASE WHEN MoM_Diff IS NULL THEN 0 ELSE 1 END)  AS Rows_With_Prior,
    SUM(Flag_ZeroToNonZero)                            AS Cnt_ZeroToNonZero,
    SUM(Flag_NonZeroToZero)                            AS Cnt_NonZeroToZero,
    SUM(Flag_Z_2plus)                                  AS Cnt_Z_Abs_2plus,
    SUM(Flag_Z_3plus)                                  AS Cnt_Z_Abs_3plus
FROM #Stats;





/*==========================================================
  MoM SecUnfunded Variance @ CreditLine
  Current month = 08/31/2025
  Prior month   = 07/31/2025
==========================================================*/

SET NOCOUNT ON;

DECLARE @CurrEOM date = '2025-08-31';
DECLARE @PrevEOM date = '2025-07-31';

/* Current snapshot */
IF OBJECT_ID('tempdb..#Curr') IS NOT NULL DROP TABLE #Curr;

SELECT
    cu.CreditLineNumber,
    cl.CIF,
    cl.ClientName,
    cl.ApplID,
    cl.FormulaLine,
    cl.BankCode,
    CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded_Curr
INTO #Curr
FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
  ON cl.LoadDate = cu.LoadDate
 AND cl.CreditLineNumber = cu.CreditLineNumber
WHERE cu.LoadDate = @CurrEOM
  AND cl.LoadDate = @CurrEOM;

/* Prior snapshot */
IF OBJECT_ID('tempdb..#Prev') IS NOT NULL DROP TABLE #Prev;

SELECT
    cu.CreditLineNumber,
    cl.CIF,
    cl.ClientName,
    cl.ApplID,
    cl.FormulaLine,
    cl.BankCode,
    CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded_Prev
INTO #Prev
FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
LEFT JOIN CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
  ON cl.LoadDate = cu.LoadDate
 AND cl.CreditLineNumber = cu.CreditLineNumber
WHERE cu.LoadDate = @PrevEOM
  AND cl.LoadDate = @PrevEOM;

/* MoM Variance */
SELECT
    COALESCE(c.CreditLineNumber, p.CreditLineNumber) AS CreditLineNumber,
    COALESCE(c.CIF, p.CIF)           AS CIF,
    COALESCE(c.ClientName, p.ClientName) AS ClientName,
    COALESCE(c.ApplID, p.ApplID)     AS ApplID,
    COALESCE(c.FormulaLine, p.FormulaLine) AS FormulaLine,
    COALESCE(c.BankCode, p.BankCode) AS BankCode,

    @CurrEOM AS LoadDate_Curr,
    @PrevEOM AS LoadDate_Prev,

    ISNULL(c.SecUnfunded_Curr,0.00) AS SecUnfunded_Curr,
    ISNULL(p.SecUnfunded_Prev,0.00) AS SecUnfunded_Prev,

    CAST(ISNULL(c.SecUnfunded_Curr,0.00) - ISNULL(p.SecUnfunded_Prev,0.00) AS decimal(38,2)) AS MoM_Diff,
    CAST(
      CASE WHEN ISNULL(p.SecUnfunded_Prev,0.00) = 0 THEN NULL
           ELSE (ISNULL(c.SecUnfunded_Curr,0.00) - ISNULL(p.SecUnfunded_Prev,0.00))
                 / NULLIF(ABS(p.SecUnfunded_Prev),0.00)
      END AS decimal(38,6)
    ) AS MoM_Pct,

    CASE WHEN ISNULL(p.SecUnfunded_Prev,0.00) = 0 AND ISNULL(c.SecUnfunded_Curr,0.00) <> 0 THEN 1 ELSE 0 END AS Flag_ZeroToNonZero,
    CASE WHEN ISNULL(p.SecUnfunded_Prev,0.00) <> 0 AND ISNULL(c.SecUnfunded_Curr,0.00) = 0 THEN 1 ELSE 0 END AS Flag_NonZeroToZero
FROM #Curr c
FULL OUTER JOIN #Prev p
  ON c.CreditLineNumber = p.CreditLineNumber
ORDER BY ABS(ISNULL(c.SecUnfunded_Curr,0.00) - ISNULL(p.SecUnfunded_Prev,0.00)) DESC;






/*==========================================================
  MoM SecUnfunded Variance @ CreditLine (no RunID)
  - Auto-detects the latest two LoadDates from CALCULATED_UNFUNDED
  - Joins optional line metadata from CREDIT_LINE_MONTHLY (current/prior)
  - Safe math, zero↔nonzero flags
==========================================================*/

SET NOCOUNT ON;

/* 1) Identify the latest two LoadDates present in CALCULATED_UNFUNDED */
IF OBJECT_ID('tempdb..#EOM') IS NOT NULL DROP TABLE #EOM;
WITH DistinctDates AS (
  SELECT DISTINCT LoadDate
  FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED
),
Ranked AS (
  SELECT LoadDate,
         ROW_NUMBER() OVER (ORDER BY LoadDate DESC) AS rn
  FROM DistinctDates
)
SELECT
  MAX(CASE WHEN rn = 1 THEN LoadDate END) AS CurrEOM,
  MAX(CASE WHEN rn = 2 THEN LoadDate END) AS PrevEOM
INTO #EOM
FROM Ranked
WHERE rn IN (1,2);

-- Optional: quick sanity check
-- SELECT * FROM #EOM;

/* 2) Build current & prior SecUnfunded snapshots */
IF OBJECT_ID('tempdb..#Curr') IS NOT NULL DROP TABLE #Curr;
IF OBJECT_ID('tempdb..#Prev') IS NOT NULL DROP TABLE #Prev;

;WITH E AS (
  SELECT CurrEOM, PrevEOM FROM #EOM
), CU_Curr AS (
  SELECT cu.LoadDate,
         cu.CreditLineNumber,
         CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded
  FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
  CROSS JOIN E
  WHERE cu.LoadDate = E.CurrEOM
), CL_Curr AS (
  SELECT cl.LoadDate,
         cl.CreditLineNumber,
         cl.CIF,
         cl.ClientName,
         cl.ApplID,
         cl.FormulaLine,
         cl.BankCode
  FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
  CROSS JOIN (SELECT CurrEOM FROM #EOM) d
  WHERE cl.LoadDate = d.CurrEOM
  -- Optional business scope (uncomment to narrow):
  -- AND cl.ApplID = 'LN'
  -- AND cl.FormulaLine = 1
)
SELECT
    c.LoadDate,
    c.CreditLineNumber,
    m.CIF,
    m.ClientName,
    m.ApplID,
    m.FormulaLine,
    m.BankCode,
    c.SecUnfunded AS SecUnfunded_Curr
INTO #Curr
FROM CU_Curr c
LEFT JOIN CL_Curr m
  ON m.LoadDate = c.LoadDate
 AND m.CreditLineNumber = c.CreditLineNumber;

;WITH E AS (
  SELECT CurrEOM, PrevEOM FROM #EOM
), CU_Prev AS (
  SELECT cu.LoadDate,
         cu.CreditLineNumber,
         CAST(cu.SecUnfunded AS decimal(38,2)) AS SecUnfunded
  FROM CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED cu
  CROSS JOIN E
  WHERE cu.LoadDate = E.PrevEOM
), CL_Prev AS (
  SELECT cl.LoadDate,
         cl.CreditLineNumber,
         cl.CIF,
         cl.ClientName,
         cl.ApplID,
         cl.FormulaLine,
         cl.BankCode
  FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY cl
  CROSS JOIN (SELECT PrevEOM FROM #EOM) d
  WHERE cl.LoadDate = d.PrevEOM
  -- Optional business scope (uncomment to narrow):
  -- AND cl.ApplID = 'LN'
  -- AND cl.FormulaLine = 1
)
SELECT
    p.LoadDate,
    p.CreditLineNumber,
    m.CIF,
    m.ClientName,
    m.ApplID,
    m.FormulaLine,
    m.BankCode,
    p.SecUnfunded AS SecUnfunded_Prev
INTO #Prev
FROM CU_Prev p
LEFT JOIN CL_Prev m
  ON m.LoadDate = p.LoadDate
 AND m.CreditLineNumber = p.CreditLineNumber;

/* 3) Compute MoM */
IF OBJECT_ID('tempdb..#MoM') IS NOT NULL DROP TABLE #MoM;

DECLARE @CurrEOM date = (SELECT CurrEOM FROM #EOM);
DECLARE @PrevEOM date = (SELECT PrevEOM FROM #EOM);

SELECT
    COALESCE(c.CreditLineNumber, p.CreditLineNumber) AS CreditLineNumber,

    -- Prefer current metadata if present
    COALESCE(c.CIF,        p.CIF)        AS CIF,
    COALESCE(c.ClientName, p.ClientName) AS ClientName,
    COALESCE(c.ApplID,     p.ApplID)     AS ApplID,
    COALESCE(c.FormulaLine,p.FormulaLine)AS FormulaLine,
    COALESCE(c.BankCode,   p.BankCode)   AS BankCode,

    @CurrEOM AS LoadDate_Curr,
    @PrevEOM AS LoadDate_Prev,

    ISNULL(c.SecUnfunded_Curr, 0.00) AS SecUnfunded_Curr,
    ISNULL(p.SecUnfunded_Prev, 0.00) AS SecUnfunded_Prev,

    CAST(ISNULL(c.SecUnfunded_Curr,0.00) - ISNULL(p.SecUnfunded_Prev,0.00) AS decimal(38,2)) AS MoM_Diff,
    CAST(CASE
           WHEN ISNULL(p.SecUnfunded_Prev,0.00) = 0 THEN NULL
           ELSE (ISNULL(c.SecUnfunded_Curr,0.00) - ISNULL(p.SecUnfunded_Prev,0.00))
                / NULLIF(ABS(p.SecUnfunded_Prev),0.00)
         END AS decimal(38,6)) AS MoM_Pct,

    CASE WHEN ISNULL(p.SecUnfunded_Prev,0.00) = 0 AND ISNULL(c.SecUnfunded_Curr,0.00) <> 0 THEN 1 ELSE 0 END AS Flag_ZeroToNonZero,
    CASE WHEN ISNULL(p.SecUnfunded_Prev,0.00) <> 0 AND ISNULL(c.SecUnfunded_Curr,0.00) = 0 THEN 1 ELSE 0 END AS Flag_NonZeroToZero
INTO #MoM
FROM #Curr c
FULL OUTER JOIN #Prev p
  ON c.CreditLineNumber = p.CreditLineNumber;

/* 4) Results */
-- Detailed variances
SELECT *
FROM #MoM
ORDER BY ABS(MoM_Diff) DESC, CreditLineNumber;

-- Quick top movers
SELECT TOP 25 * FROM #MoM ORDER BY MoM_Diff DESC, CreditLineNumber; -- biggest increases
SELECT TOP 25 * FROM #MoM ORDER BY MoM_Diff ASC,  CreditLineNumber; -- biggest decreases

-- Optional rollups (uncomment as needed):
-- SELECT BankCode, SUM(SecUnfunded_Prev) AS Prev_, SUM(SecUnfunded_Curr) AS Curr_, SUM(MoM_Diff) AS MoM_Diff
-- FROM #MoM GROUP BY BankCode ORDER BY ABS(SUM(MoM_Diff)) DESC;






-- === Define the two months once ===
DECLARE @PrevDate date = DATEFROMPARTS(2025,7,31);
DECLARE @CurrDate date = DATEFROMPARTS(2025,8,31);

WITH Prev AS (
    SELECT 
        CAST(a.LoadDate AS date)                                AS LoadDate,
        a.Cif,
        a.CreditLineNumber,
        a.RevolvingFlag,
        a.FormulaLine,
        CAST(a.NetBorrowingBase AS decimal(19,2))               AS NetBorrowingBase,
        CAST(a.GrossLineAmount  AS decimal(19,2))               AS GrossLineAmount,
        CAST(a.NetLineAmount    AS decimal(19,2))               AS NetLineAmount,
        CAST(a.NetUtilized      AS decimal(19,2))               AS NetUtilized,
        CAST(b.SecUnfunded      AS decimal(19,2))               AS SecUnfunded,
        CAST(CASE
            WHEN a.NetBorrowingBase < a.NetLineAmount 
                 THEN (a.NetBorrowingBase - a.NetUtilized)
            ELSE      (a.NetLineAmount   - a.NetUtilized)
        END AS decimal(19,2))                                   AS Recalculated_SecUnfunded
    FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
    LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
        ON a.LoadDate = b.LoadDate
       AND a.CreditLineNumber = b.CreditLineNumber
    WHERE a.LoadDate = @PrevDate
      AND a.CreditLineNumber IN (
        '200147535IMXARLINE1',
        '200082386IMXARLINE2',
        '200287492IMXARLINE1',
        '200093013IMXARLINE1',
        '200056647IMXARLINE1')
),
Curr AS (
    SELECT 
        CAST(a.LoadDate AS date)                                AS LoadDate,
        a.Cif,
        a.CreditLineNumber,
        a.RevolvingFlag,
        a.FormulaLine,
        CAST(a.NetBorrowingBase AS decimal(19,2))               AS NetBorrowingBase,
        CAST(a.GrossLineAmount  AS decimal(19,2))               AS GrossLineAmount,
        CAST(a.NetLineAmount    AS decimal(19,2))               AS NetLineAmount,
        CAST(a.NetUtilized      AS decimal(19,2))               AS NetUtilized,
        CAST(b.SecUnfunded      AS decimal(19,2))               AS SecUnfunded,
        CAST(CASE
            WHEN a.NetBorrowingBase < a.NetLineAmount 
                 THEN (a.NetBorrowingBase - a.NetUtilized)
            ELSE      (a.NetLineAmount   - a.NetUtilized)
        END AS decimal(19,2))                                   AS Recalculated_SecUnfunded
    FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
    LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
        ON a.LoadDate = b.LoadDate
       AND a.CreditLineNumber = b.CreditLineNumber
    WHERE a.LoadDate = @CurrDate
      AND a.CreditLineNumber IN (
        '200147535IMXARLINE1',
        '200082386IMXARLINE2',
        '200287492IMXARLINE1',
        '200093013IMXARLINE1',
        '200056647IMXARLINE1')
)

SELECT
    c.LoadDate,
    c.Cif,
    c.CreditLineNumber,
    c.RevolvingFlag,
    c.FormulaLine,

    p.NetBorrowingBase  AS PrevMonth_NetBorrowingBase,
    c.NetBorrowingBase  AS CurrMonth_NetBorrowingBase,
    ISNULL(c.NetBorrowingBase,0)  - ISNULL(p.NetBorrowingBase,0)  AS NetBorrowingBase_Change,

    p.GrossLineAmount   AS PrevMonth_GrossLineAmount,
    c.GrossLineAmount   AS CurrMonth_GrossLineAmount,
    ISNULL(c.GrossLineAmount,0)   - ISNULL(p.GrossLineAmount,0)   AS GrossLineAmount_Change,

    p.NetLineAmount     AS PrevMonth_NetLineAmount,
    c.NetLineAmount     AS CurrMonth_NetLineAmount,
    ISNULL(c.NetLineAmount,0)     - ISNULL(p.NetLineAmount,0)     AS NetLineAmount_Change,

    p.NetUtilized       AS PrevMonth_NetUtilized,
    c.NetUtilized       AS CurrMonth_NetUtilized,
    ISNULL(c.NetUtilized,0)       - ISNULL(p.NetUtilized,0)       AS NetUtilized_Change,

    p.SecUnfunded       AS PrevMonth_SecUnfunded,
    c.SecUnfunded       AS CurrMonth_SecUnfunded,
    ISNULL(c.SecUnfunded,0)       - ISNULL(p.SecUnfunded,0)       AS SecUnfunded_Change,

    p.Recalculated_SecUnfunded AS PrevMonth_Recalc_SecUnfunded,
    c.Recalculated_SecUnfunded AS CurrMonth_Recalc_SecUnfunded,
    ISNULL(c.Recalculated_SecUnfunded,0) - ISNULL(p.Recalculated_SecUnfunded,0) AS Recalc_SecUnfunded_Change
FROM Curr c
LEFT JOIN Prev p
  ON p.CreditLineNumber = c.CreditLineNumber;





IF OBJECT_ID('tempdb..#PrevMonth') IS NOT NULL DROP TABLE #PrevMonth;
IF OBJECT_ID('tempdb..#CurrMonth') IS NOT NULL DROP TABLE #CurrMonth;

-- === PREVIOUS MONTH: keep raw numeric column names ===
SELECT 
    CAST(a.LoadDate AS date)                  AS LoadDate, 
    a.Cif, 
    a.CreditLineNumber, 
    a.RevolvingFlag, 
    a.FormulaLine, 
    CAST(a.NetBorrowingBase AS decimal(19,2)) AS NetBorrowingBase, 
    CAST(a.GrossLineAmount  AS decimal(19,2)) AS GrossLineAmount, 
    CAST(a.NetLineAmount    AS decimal(19,2)) AS NetLineAmount, 
    CAST(a.NetUtilized      AS decimal(19,2)) AS NetUtilized, 
    CAST(b.SecUnfunded      AS decimal(19,2)) AS SecUnfunded, 
    CAST(CASE
        WHEN a.NetBorrowingBase < a.NetLineAmount 
             THEN (a.NetBorrowingBase - a.NetUtilized)
        ELSE      (a.NetLineAmount   - a.NetUtilized)
    END AS decimal(19,2))                     AS Recalculated_SecUnfunded
INTO #PrevMonth
FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
  ON a.LoadDate = b.LoadDate 
 AND a.CreditLineNumber = b.CreditLineNumber
WHERE a.LoadDate = DATEFROMPARTS(2025,7,31)
  AND a.CreditLineNumber IN (
    '200147535IMXARLINE1',
    '200082386IMXARLINE2',
    '200287492IMXARLINE1',
    '200093013IMXARLINE1',
    '200056647IMXARLINE1');

-- === CURRENT MONTH: keep raw numeric column names ===
SELECT 
    CAST(a.LoadDate AS date)                  AS LoadDate, 
    a.Cif, 
    a.CreditLineNumber, 
    a.RevolvingFlag, 
    a.FormulaLine, 
    CAST(a.NetBorrowingBase AS decimal(19,2)) AS NetBorrowingBase, 
    CAST(a.GrossLineAmount  AS decimal(19,2)) AS GrossLineAmount, 
    CAST(a.NetLineAmount    AS decimal(19,2)) AS NetLineAmount, 
    CAST(a.NetUtilized      AS decimal(19,2)) AS NetUtilized,
    CAST(b.SecUnfunded      AS decimal(19,2)) AS SecUnfunded, 
    CAST(CASE
        WHEN a.NetBorrowingBase < a.NetLineAmount 
             THEN (a.NetBorrowingBase - a.NetUtilized)
        ELSE      (a.NetLineAmount   - a.NetUtilized)
    END AS decimal(19,2))                     AS Recalculated_SecUnfunded
INTO #CurrMonth
FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
  ON a.LoadDate = b.LoadDate 
 AND a.CreditLineNumber = b.CreditLineNumber
WHERE a.LoadDate = DATEFROMPARTS(2025,8,31)
  AND a.CreditLineNumber IN (
    '200147535IMXARLINE1',
    '200082386IMXARLINE2',
    '200287492IMXARLINE1',
    '200093013IMXARLINE1',
    '200056647IMXARLINE1');

-- === COMPARE (numeric math only; no FORMAT anywhere) ===
SELECT
    cm.LoadDate,
    cm.Cif,
    cm.CreditLineNumber,
    cm.RevolvingFlag,
    cm.FormulaLine,

    -- show raw values
    pm.NetBorrowingBase  AS PrevMonth_NetBorrowingBase,
    cm.NetBorrowingBase  AS CurrMonth_NetBorrowingBase,
    ISNULL(cm.NetBorrowingBase,0)  - ISNULL(pm.NetBorrowingBase,0)  AS NetBorrowingBase_Change,

    pm.GrossLineAmount   AS PrevMonth_GrossLineAmount,
    cm.GrossLineAmount   AS CurrMonth_GrossLineAmount,
    ISNULL(cm.GrossLineAmount,0)   - ISNULL(pm.GrossLineAmount,0)   AS GrossLineAmount_Change,

    pm.NetLineAmount     AS PrevMonth_NetLineAmount,
    cm.NetLineAmount     AS CurrMonth_NetLineAmount,
    ISNULL(cm.NetLineAmount,0)     - ISNULL(pm.NetLineAmount,0)     AS NetLineAmount_Change,

    pm.NetUtilized       AS PrevMonth_NetUtilized,
    cm.NetUtilized       AS CurrMonth_NetUtilized,
    ISNULL(cm.NetUtilized,0)       - ISNULL(pm.NetUtilized,0)       AS NetUtilized_Change,

    pm.SecUnfunded       AS PrevMonth_SecUnfunded,
    cm.SecUnfunded       AS CurrMonth_SecUnfunded,
    ISNULL(cm.SecUnfunded,0)       - ISNULL(pm.SecUnfunded,0)       AS SecUnfunded_Change,

    pm.Recalculated_SecUnfunded AS PrevMonth_Recalc_SecUnfunded,
    cm.Recalculated_SecUnfunded AS CurrMonth_Recalc_SecUnfunded,
    ISNULL(cm.Recalculated_SecUnfunded,0) - ISNULL(pm.Recalculated_SecUnfunded,0) AS Recalc_SecUnfunded_Change

FROM #CurrMonth cm
LEFT JOIN #PrevMonth pm
  ON pm.CreditLineNumber = cm.CreditLineNumber
 AND pm.LoadDate = DATEADD(MONTH, -1, cm.LoadDate);








IF OBJECT_ID('tempdb..#PrevMonth') IS NOT NULL DROP TABLE #PrevMonth;
IF OBJECT_ID('tempdb..#CurrMonth') IS NOT NULL DROP TABLE #CurrMonth;

-- PREVIOUS MONTH (keep numeric, original names)
SELECT 
    CAST(a.LoadDate AS date)                      AS LoadDate, 
    a.Cif, 
    a.CreditLineNumber, 
    a.RevolvingFlag, 
    a.FormulaLine, 
    CAST(a.NetBorrowingBase AS decimal(19,2))     AS NetBorrowingBase, 
    CAST(a.GrossLineAmount  AS decimal(19,2))     AS GrossLineAmount, 
    CAST(a.NetLineAmount    AS decimal(19,2))     AS NetLineAmount, 
    CAST(a.NetUtilized      AS decimal(19,2))     AS NetUtilized, 
    CAST(b.SecUnfunded      AS decimal(19,2))     AS SecUnfunded, 
    CAST(CASE
        WHEN a.NetBorrowingBase < a.NetLineAmount 
             THEN (a.NetBorrowingBase - a.NetUtilized)
        ELSE      (a.NetLineAmount   - a.NetUtilized)
    END AS decimal(19,2))                          AS Recalculated_SecUnfunded
INTO #PrevMonth
FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
  ON a.LoadDate = b.LoadDate 
 AND a.CreditLineNumber = b.CreditLineNumber
WHERE a.LoadDate = DATEFROMPARTS(2025,7,31)
  AND a.CreditLineNumber IN (
    '200147535IMXARLINE1',
    '200082386IMXARLINE2',
    '200287492IMXARLINE1',
    '200093013IMXARLINE1',
    '200056647IMXARLINE1');

-- CURRENT MONTH (keep numeric, original names)
SELECT 
    CAST(a.LoadDate AS date)                      AS LoadDate, 
    a.Cif, 
    a.CreditLineNumber, 
    a.RevolvingFlag, 
    a.FormulaLine, 
    CAST(a.NetBorrowingBase AS decimal(19,2))     AS NetBorrowingBase, 
    CAST(a.GrossLineAmount  AS decimal(19,2))     AS GrossLineAmount, 
    CAST(a.NetLineAmount    AS decimal(19,2))     AS NetLineAmount, 
    CAST(a.NetUtilized      AS decimal(19,2))     AS NetUtilized,
    CAST(b.SecUnfunded      AS decimal(19,2))     AS SecUnfunded, 
    CAST(CASE
        WHEN a.NetBorrowingBase < a.NetLineAmount 
             THEN (a.NetBorrowingBase - a.NetUtilized)
        ELSE      (a.NetLineAmount   - a.NetUtilized)
    END AS decimal(19,2))                          AS Recalculated_SecUnfunded
INTO #CurrMonth
FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
  ON a.LoadDate = b.LoadDate 
 AND a.CreditLineNumber = b.CreditLineNumber
WHERE a.LoadDate = DATEFROMPARTS(2025,8,31)
  AND a.CreditLineNumber IN (
    '200147535IMXARLINE1',
    '200082386IMXARLINE2',
    '200287492IMXARLINE1',
    '200093013IMXARLINE1',
    '200056647IMXARLINE1');

-- COMPARE (math on numerics; optional FORMAT for display)
SELECT
    cm.LoadDate,
    cm.Cif,
    cm.CreditLineNumber,
    cm.RevolvingFlag,
    cm.FormulaLine,

    -- optional pretty display of raw values
    FORMAT(pm.NetBorrowingBase, 'N2') AS PrevMonth_NetBorrowingBase_fmtd,
    FORMAT(cm.NetBorrowingBase, 'N2') AS CurrMonth_NetBorrowingBase_fmtd,
    ISNULL(cm.NetBorrowingBase,0) - ISNULL(pm.NetBorrowingBase,0) AS NetBorrowingBase_Change,

    FORMAT(pm.GrossLineAmount, 'N2')  AS PrevMonth_GrossLineAmount_fmtd,
    FORMAT(cm.GrossLineAmount, 'N2')  AS CurrMonth_GrossLineAmount_fmtd,
    ISNULL(cm.GrossLineAmount,0) - ISNULL(pm.GrossLineAmount,0)   AS GrossLineAmount_Change,

    FORMAT(pm.NetLineAmount, 'N2')    AS PrevMonth_NetLineAmount_fmtd,
    FORMAT(cm.NetLineAmount, 'N2')    AS CurrMonth_NetLineAmount_fmtd,
    ISNULL(cm.NetLineAmount,0) - ISNULL(pm.NetLineAmount,0)       AS NetLineAmount_Change,

    FORMAT(pm.NetUtilized, 'N2')      AS PrevMonth_NetUtilized_fmtd,
    FORMAT(cm.NetUtilized, 'N2')      AS CurrMonth_NetUtilized_fmtd,
    ISNULL(cm.NetUtilized,0) - ISNULL(pm.NetUtilized,0)           AS NetUtilized_Change,

    FORMAT(pm.SecUnfunded, 'N2')      AS PrevMonth_SecUnfunded_fmtd,
    FORMAT(cm.SecUnfunded, 'N2')      AS CurrMonth_SecUnfunded_fmtd,
    ISNULL(cm.SecUnfunded,0) - ISNULL(pm.SecUnfunded,0)           AS SecUnfunded_Change,

    -- recalculated sec unfunded comparison (numeric)
    ISNULL(cm.Recalculated_SecUnfunded,0) - ISNULL(pm.Recalculated_SecUnfunded,0) AS Recalc_SecUnfunded_Change
FROM #CurrMonth cm
LEFT JOIN #PrevMonth pm
  ON pm.CreditLineNumber = cm.CreditLineNumber
 AND pm.LoadDate = DATEADD(MONTH, -1, cm.LoadDate);






IF OBJECT_ID('tempdb..#PrevMonth') IS NOT NULL DROP TABLE #PrevMonth;
IF OBJECT_ID('tempdb..#CurrMonth') IS NOT NULL DROP TABLE #CurrMonth;

-- Previous month (numeric, not formatted)
SELECT 
    CAST(a.LoadDate AS date)                     AS LoadDate, 
    a.Cif, 
    a.CreditLineNumber, 
    a.RevolvingFlag, 
    a.FormulaLine, 
    CAST(a.NetBorrowingBase     AS decimal(19,2)) AS PrevMonth_NetBorrowingBase, 
    CAST(a.GrossLineAmount      AS decimal(19,2)) AS PrevMonth_GrossLineAmount, 
    CAST(a.NetLineAmount        AS decimal(19,2)) AS PrevMonth_NetLineAmount, 
    CAST(a.NetUtilized          AS decimal(19,2)) AS PrevMonth_NetUtilized, 
    CAST(b.SecUnfunded          AS decimal(19,2)) AS PrevMonth_SecUnfunded, 
    CAST(CASE
        WHEN a.NetBorrowingBase < a.NetLineAmount THEN (a.NetBorrowingBase - a.NetUtilized)
        ELSE (a.NetLineAmount - a.NetUtilized)
    END AS decimal(19,2))                         AS PrevMonth_Recalculated_SecUnfunded
INTO #PrevMonth
FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
  ON a.LoadDate = b.LoadDate 
 AND a.CreditLineNumber = b.CreditLineNumber
WHERE a.LoadDate = '2025-07-31'
  AND a.CreditLineNumber IN (
    '200147535IMXARLINE1',
    '200082386IMXARLINE2',
    '200287492IMXARLINE1',
    '200093013IMXARLINE1',
    '200056647IMXARLINE1');

-- Current month (numeric, not formatted)
SELECT 
    CAST(a.LoadDate AS date)                     AS LoadDate, 
    a.Cif, 
    a.CreditLineNumber, 
    a.RevolvingFlag, 
    a.FormulaLine, 
    CAST(a.NetBorrowingBase     AS decimal(19,2)) AS CurrMonth_NetBorrowingBase, 
    CAST(a.GrossLineAmount      AS decimal(19,2)) AS CurrMonth_GrossLineAmount, 
    CAST(a.NetLineAmount        AS decimal(19,2)) AS CurrMonth_NetLineAmount, 
    CAST(a.NetUtilized          AS decimal(19,2)) AS CurrMonth_NetUtilized,
    CAST(b.SecUnfunded          AS decimal(19,2)) AS CurrMonth_SecUnfunded, 
    CAST(CASE
        WHEN a.NetBorrowingBase < a.NetLineAmount THEN (a.NetBorrowingBase - a.NetUtilized)
        ELSE (a.NetLineAmount - a.NetUtilized)
    END AS decimal(19,2))                         AS CurrMonth_Recalculated_SecUnfunded
INTO #CurrMonth
FROM CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
LEFT JOIN CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
  ON a.LoadDate = b.LoadDate 
 AND a.CreditLineNumber = b.CreditLineNumber
WHERE a.LoadDate = '2025-08-31'
  AND a.CreditLineNumber IN (
    '200147535IMXARLINE1',
    '200082386IMXARLINE2',
    '200287492IMXARLINE1',
    '200093013IMXARLINE1',
    '200056647IMXARLINE1');

-- Compare (do math on numerics; format at the end if desired)
SELECT
    cm.LoadDate,
    cm.Cif,
    cm.CreditLineNumber,
    cm.RevolvingFlag,
    cm.FormulaLine,

    -- Optional pretty display
    FORMAT(pm.PrevMonth_NetBorrowingBase, 'N2') AS PrevMonth_NetBorrowingBase_fmtd,
    FORMAT(cm.CurrMonth_NetBorrowingBase, 'N2') AS CurrMonth_NetBorrowingBase_fmtd,
    cm.CurrMonth_NetBorrowingBase - pm.PrevMonth_NetBorrowingBase AS NetBorrowingBase_Change,

    FORMAT(pm.PrevMonth_GrossLineAmount, 'N2')  AS PrevMonth_GrossLineAmount_fmtd,
    FORMAT(cm.CurrMonth_GrossLineAmount, 'N2')  AS CurrMonth_GrossLineAmount_fmtd,
    cm.CurrMonth_GrossLineAmount - pm.PrevMonth_GrossLineAmount   AS GrossLineAmount_Change,

    FORMAT(pm.PrevMonth_NetLineAmount, 'N2')    AS PrevMonth_NetLineAmount_fmtd,
    FORMAT(cm.CurrMonth_NetLineAmount, 'N2')    AS CurrMonth_NetLineAmount_fmtd,
    cm.CurrMonth_NetLineAmount - pm.PrevMonth_NetLineAmount       AS NetLineAmount_Change,

    FORMAT(pm.PrevMonth_NetUtilized, 'N2')      AS PrevMonth_NetUtilized_fmtd,
    FORMAT(cm.CurrMonth_NetUtilized, 'N2')      AS CurrMonth_NetUtilized_fmtd,
    cm.CurrMonth_NetUtilized - pm.PrevMonth_NetUtilized           AS NetUtilized_Change,

    FORMAT(pm.PrevMonth_SecUnfunded, 'N2')      AS PrevMonth_SecUnfunded_fmtd,
    FORMAT(cm.CurrMonth_SecUnfunded, 'N2')      AS CurrMonth_SecUnfunded_fmtd,
    cm.CurrMonth_SecUnfunded - pm.PrevMonth_SecUnfunded           AS SecUnfunded_Change

FROM #CurrMonth cm
LEFT JOIN #PrevMonth pm
  ON pm.CreditLineNumber = cm.CreditLineNumber
 AND pm.LoadDate = DATEADD(MONTH, -1, cm.LoadDate);







IF OBJECT_ID('tempdb..#PrevMonth')   IS NOT NULL DROP TABLE #PrevMonth;
IF OBJECT_ID('tempdb..#CurrMonth')  IS NOT NULL DROP TABLE #CurrMonth;

select 
	cast(a.LoadDate as date) as LoadDate, 
	a.Cif, 
	a.CreditLineNumber, 
	a.RevolvingFlag, 
	a.FormulaLine, 
	format(a.NetBorrowingBase,'N2') as PrevMonth_NetBorrowingBase_fmtd, 
	format(a.GrossLineAmount,'N2') as PrevMonth_GrossLineAmount_fmtd, 
	format(a.NetLineAmount,'N2') as PrevMonth_NetLineAmount_fmtd, 
	format(a.NetUtilized,'N2') as PrevMonth_NetUtilized_fmtd, 
	format(b.SecUnfunded,'N2') as PrevMonth_SecUnfunded_fmtd, 
	case
		when a.NetBorrowingBase < a.NetLineAmount then (a.NetBorrowingBase - a.NetUtilized)
		else (a.NetLineAmount - a.NetUtilized)
		end as PrevMonth_Recalculated_SecUnfunded
into #PrevMonth
from CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
left join CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
on a.LoadDate = b.LoadDate and a.CreditLineNumber = b.CreditLineNumber
where a.LoadDate = '7/31/2025' and a.CreditLineNumber in (
	'200147535IMXARLINE1',
	'200082386IMXARLINE2',
	'200287492IMXARLINE1',
	'200093013IMXARLINE1',
	'200056647IMXARLINE1')

select 
	cast(a.LoadDate as date) as LoadDate, 
	a.Cif, 
	a.CreditLineNumber, 
	a.RevolvingFlag, 
	a.FormulaLine, 
	format(a.NetBorrowingBase,'N2') as CurrMonth_NetBorrowingBase_fmtd, 
	format(a.GrossLineAmount,'N2') as CurrMonth_GrossLineAmount_fmtd, 
	format(a.NetLineAmount,'N2') as CurrMonth_NetLineAmount_fmtd, 
	format(a.NetUtilized,'N2') as CurrMonth_NetUtilized_fmtd,
	format(b.SecUnfunded,'N2') as CurrMonth_SecUnfunded_fmtd, 
	case
		when a.NetBorrowingBase < a.NetLineAmount then (a.NetBorrowingBase - a.NetUtilized)
		else (a.NetLineAmount - a.NetUtilized)
		end as CurrMonth_Recalculated_SecUnfunded
into #CurrMonth
from CRDLMTUFCALC.dbo.CREDIT_LINE_MONTHLY a
left join CRDLMTUFCALC.dbo.CALCULATED_UNFUNDED b
on a.LoadDate = b.LoadDate and a.CreditLineNumber = b.CreditLineNumber
where a.LoadDate = '8/31/2025' and a.CreditLineNumber in (
	'200147535IMXARLINE1',
	'200082386IMXARLINE2',
	'200287492IMXARLINE1',
	'200093013IMXARLINE1',
	'200056647IMXARLINE1')

select
	cm.LoadDate,
	cm.Cif,
	cm.CreditLineNumber,
	cm.RevolvingFlag,
	cm.FormulaLine,
	pm.PrevMonth_NetBorrowingBase_fmtd,
	cm.CurrMonth_NetBorrowingBase_fmtd,
	(cm.CurrMonth_NetBorrowingBase_fmtd - pm.PrevMonth_NetBorrowingBase_fmtd) as NetBorrowingBase_Change,
	pm.PrevMonth_GrossLineAmount_fmtd,
	cm.CurrMonth_GrossLineAmount_fmtd,
	(cm.CurrMonth_GrossLineAmount_fmtd - pm.PrevMonth_GrossLineAmount_fmtd) as GrossLineAmount_Change,
	pm.PrevMonth_NetLineAmount_fmtd,
	cm.CurrMonth_NetLineAmount_fmtd,
	(cm.CurrMonth_NetLineAmount_fmtd - pm.PrevMonth_NetLineAmount_fmtd) as NetLineAmount_Change,
	pm.PrevMonth_NetUtilized_fmtd,
	cm.CurrMonth_NetUtilized_fmtd,
	(cm.CurrMonth_NetUtilized_fmtd - pm.PrevMonth_NetUtilized_fmtd) as NetUtilized_Change,
	pm.PrevMonth_SecUnfunded_fmtd,
	cm.CurrMonth_SecUnfunded_fmtd,
	(cm.CurrMonth_SecUnfunded_fmtd - pm.PrevMonth_SecUnfunded_fmtd) as SecUnfunded_Change
from #CurrMonth cm
left join #PrevMonth pm
on cm.LoadDate = pm.LoadDate and cm.CreditLineNumber = pm.CreditLineNumber






/* ===== Last 12 months detail with derived System & Commitment ===== */
WITH bounds AS (
    SELECT AsOfMonthEnd = (SELECT MAX(m.LoadDate) FROM CRDLMTUFCALC.dbo.Credit_Line_Monthly AS m)
),
win AS (
    SELECT AsOfMonthEnd, StartMonthEnd = DATEADD(MONTH, -11, AsOfMonthEnd)
    FROM bounds
)
SELECT
    LoadDate         = CONVERT(date, m.LoadDate),             -- month end (from Credit_Line_Monthly)
    ApplID           = m.ApplID,                              -- keep if present; drop if not
    CreditLineNumber = m.CreditLineNumber,
    SecUnfunded      = u.SecUnfunded,                         -- from Calculated_Unfunded
    NetUtilized      = m.NetUtilized,
    Commitment       = m.NetUtilized + u.SecUnfunded,
    System = CASE
                WHEN c.Cust_Line_Number IS NOT NULL           THEN 'Cards'          -- Cards first
                WHEN m.Source = 'CF'                          THEN 'CFD'
                WHEN m.CreditLineNumber LIKE '%iMX%'          THEN 'iMX'
                WHEN m.Source = 'LN'                          THEN 'CBS'
                WHEN m.Source = 'LO'                          THEN 'UBS'
                WHEN m.Source = 'LJ'                          THEN 'LJ'
                ELSE ISNULL(NULLIF(m.Source,''), 'Unknown')
             END
FROM CRDLMTUFCALC.dbo.Credit_Line_Monthly            AS m
JOIN CRDLMTUFCALC.dbo.Calculated_Unfunded            AS u
  ON u.CreditLineNumber = m.CreditLineNumber
 AND u.LoadDate         = m.LoadDate
LEFT JOIN crdadmprd.dbo.CDM_Cards_Loan               AS c
  ON c.Cust_Line_Number = m.CreditLineNumber
CROSS JOIN win w
WHERE m.LoadDate >= w.StartMonthEnd
  AND m.LoadDate <= w.AsOfMonthEnd
ORDER BY m.LoadDate, m.CreditLineNumber;
